<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f5f9ff;
  margin: 0;
}

/* ---------- LOGIN ---------- */
#loginBox {
  max-width: 360px;
  margin: 120px auto;
  background: #fff;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,.15);
  text-align: center;
}

#loginBox h2 {
  color: #1f3c88;
}

#loginBox input {
  width: 100%;
  padding: 10px;
  margin-top: 15px;
  font-size: 14px;
}

#loginBox button {
  margin-top: 20px;
  width: 100%;
  padding: 10px;
  background: #1f3c88;
  color: #fff;
  border: none;
  font-size: 15px;
  cursor: pointer;
}

#errorMsg {
  color: red;
  font-size: 13px;
  margin-top: 10px;
}

/* ---------- DASHBOARD ---------- */
#dashboard {
  display: none;
  padding: 20px;
}

h1 {
  text-align: center;
  color: #1f3c88;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ddd;
  padding: 10px;
  font-size: 14px;
  white-space: pre-wrap;
}

th {
  background: #1f3c88;
  color: #fff;
  position: sticky;
  top: 0;
}

/* Status colors */
.status-pending { background:#fff8cc; font-weight:600; }
.status-contacted { background:#e6f7e6; font-weight:600; }
.status-converted { background:#e6f0ff; font-weight:600; }
.status-closed { background:#ffe6e6; font-weight:600; }

select { width:100%; }

/* Logout */
.logout {
  float: right;
  font-size: 13px;
  cursor: pointer;
  color: #1f3c88;
  text-decoration: underline;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Study ZONE Admin</h2>
  <input type="password" id="adminPass" placeholder="Enter Admin Password">
  <button onclick="login()">Login</button>
  <div id="errorMsg"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="logout" onclick="logout()">Logout</div>
  <h1>Enrollment Requests</h1>

  <table>
    <thead><tr id="tableHeader"></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
/* ================= ACCESS CONTROL ================= */

const ADMIN_PASSWORD = "Chinu"; // ðŸ” CHANGE THIS

if (sessionStorage.getItem("sz_admin") === "true") {
  showDashboard();
}

function login() {
  const pass = document.getElementById("adminPass").value;
  if (pass === ADMIN_PASSWORD) {
    sessionStorage.setItem("sz_admin", "true");
    showDashboard();
  } else {
    document.getElementById("errorMsg").textContent = "Invalid password";
  }
}

function logout() {
  sessionStorage.removeItem("sz_admin");
  location.reload();
}

function showDashboard() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  loadData();
}

/* ================= DATA LOADING ================= */

const csvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv";

const writeBackUrl =
"https://script.google.com/macros/s/AKfycbxiKaOnBVXs1B2kdU28QfpPoOPt2gUIQyMqa80tTezAF3L09b6bbIXE6LNPoYr8YozU1A/exec";

function loadData() {
Papa.parse(csvUrl, {
  download: true,
  skipEmptyLines: true,
  complete: function(results) {

    const data = results.data;
    const headers = data[0];
    const rows = data.slice(1);

    const hEl = document.getElementById("tableHeader");
    const bEl = document.getElementById("tableBody");
    hEl.innerHTML = "";
    bEl.innerHTML = "";

    let statusIndex = headers.indexOf("Status");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      hEl.appendChild(th);
    });

    rows.slice().reverse().forEach((row, idx) => {
      const sheetRow = rows.length - idx + 2;
      const tr = document.createElement("tr");

      headers.forEach((_, i) => {
        const td = document.createElement("td");
        const cell = row[i] || "";

        if (i === statusIndex) {
          const s = document.createElement("select");
          ["Pending","Contacted","Converted","Closed"].forEach(v=>{
            const o=document.createElement("option");
            o.value=o.textContent=v;
            if (cell===v) o.selected=true;
            s.appendChild(o);
          });
          s.onchange=()=>updateStatus(sheetRow,s.value,td);
          td.appendChild(s);
          applyStatusColor(td,cell||"Pending");
        } else td.textContent = cell;

        tr.appendChild(td);
      });

      bEl.appendChild(tr);
    });
  }
});
}

function applyStatusColor(td, s) {
  td.className="status-"+s.toLowerCase();
}

function updateStatus(row,status,td){
 fetch(writeBackUrl,{
  method:"POST",
  headers:{ "Content-Type":"application/json"},
  body:JSON.stringify({ action:"updateStatus", row, status })
 });
 applyStatusColor(td,status);
}
</script>

</body>
</html>