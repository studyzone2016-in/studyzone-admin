// Authentication Check
if(sessionStorage.getItem("adminAuth")!=="true"){ location.href="index.html"; }

let fullData = [], activeIdx = null;

// --- CONFIGURATION ---
const MY_UPI_ID = "studyezonedombivli@upi";
const MY_NAME = "Study ZONE Dombivali";
// ---------------------

function normalizeMobile(r){
    if(!r) return "";
    let d = r.toString().replace(/\D/g,"");
    return d.length === 10 ? "91" + d : d;
}

function formatTrendDate(v){
    const d = new Date(v);
    if(isNaN(d)) return v || "â€”";
    return d.toLocaleDateString("en-GB", {day:"2-digit", month:"short", year:"numeric"});
}

function closeModal(){ document.getElementById('detailModal').style.display='none'; }

function openRequest(idx){
    activeIdx = idx;
    const row = fullData[idx];
    const container = document.getElementById('modalDetailsContainer');
    document.getElementById('modalName').innerText = row["Full Name"] || "Details";
    
    let html = "";
    Object.keys(row).forEach(key => {
        if(key === "Status" || key === "Timestamp") return;
        html += `<div class="detail-item">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${row[key] || "â€”"}</div>
                 </div>`;
    });
    container.innerHTML = html;

    const status = row["Status"] || "Wait";
    document.getElementById('chipWait').className = status === 'Wait' ? 'chip active-wait' : 'chip';
    document.getElementById('chipDone').className = status === 'Converted' ? 'chip active-done' : 'chip';
    document.getElementById('detailModal').style.display = 'block';
}

function updateStatusUI(newStatus) {
    fullData[activeIdx]["Status"] = newStatus;
    renderTable();
    document.getElementById('chipWait').className = newStatus === 'Wait' ? 'chip active-wait' : 'chip';
    document.getElementById('chipDone').className = newStatus === 'Converted' ? 'chip active-done' : 'chip';
}

function sendWhatsAppPopup() {
    const row = fullData[activeIdx];
    const mobile = normalizeMobile(row["Mobile Number"]);
    
    const name = (row["Full Name"] || "Student").trim().toUpperCase();
    const branch = row["Preferred Branch"] || "â€”";
    const plan = row["Preferred Plan"] || "â€”";
    const startDate = formatTrendDate(row["Start Date"]);
    const endDate = formatTrendDate(row["End Date"]);
    const days = row["No. of Days to Book"] || "â€”";
    const estCost = row["Estimated Cost"] || "0";
    const regFee = row["Registration Fees"] || "0";
    const grandTotal = row["Grand Estimated Cost"] || "0";

    // GENERATE SECURE UPI QR LINK
    // This encodes: upi://pay?pa=ID&pn=NAME&am=AMOUNT&cu=INR
    const upiString = `upi://pay?pa=${MY_UPI_ID}&pn=${encodeURIComponent(MY_NAME)}&am=${grandTotal}&cu=INR`;
    const qrImageUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent(upiString)}&choe=UTF-8`;

    const msg = `Namaste *${name}* ðŸ™

Greetings from *Study ZONE*. 

We have received your enrollment request. Please find your summary below:

ðŸ“Œ *ENROLLMENT SUMMARY*
â€¢ *Preferred Branch:* ${branch}
â€¢ *Preferred Plan:* ${plan}
â€¢ *Start Date:* ${startDate}
â€¢ *No. of Days to Book:* ${days}
â€¢ *End Date:* ${endDate}

ðŸ’³ *FEE STRUCTURE*
â€¢ Estimated Cost: â‚¹${estCost}
â€¢ Registration Fees: â‚¹${regFee}
â€¢ *Grand Estimated Cost: â‚¹${grandTotal}*

âœ… *SCAN TO PAY SAFELY*
Click the link below to view your personalized QR Code and pay via GPay/PhonePe/Paytm:
${qrImageUrl}

For any assistance, feel free to reach out to us.

Warm regards,  
*Study ZONE*`;

    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, "_blank");
}

function renderTable() {
    const body = document.getElementById('tableBody');
    body.innerHTML = "";
    fullData.forEach((row, i) => {
        const statusVal = row["Status"] || "Wait";
        const statusClass = statusVal === "Converted" ? "pill-converted" : "pill-wait";
        body.innerHTML += `
            <tr>
                <td data-label="Status"><span class="status-pill ${statusClass}">${statusVal}</span></td>
                <td data-label="Date">${formatTrendDate(row["Timestamp"])}</td>
                <td data-label="Subscriber"><a class="name-link" onclick="openRequest(${i})">${row["Full Name"] || "Unnamed"}</a></td>
                <td data-label="Mobile">
                    <a href="tel:${row["Mobile Number"]}" class="phone-link">
                        <i class="fa-solid fa-phone"></i> ${row["Mobile Number"] || "â€”"}
                    </a>
                </td>
            </tr>
        `;
    });
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
        fullData = results.data.filter(r => r["Full Name"]).reverse();
        renderTable();
    }
});