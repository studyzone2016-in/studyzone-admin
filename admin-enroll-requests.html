<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Requests Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --brand:#1f3c88;
  --bg:#f4f7fc;
  --card:#fff;
  --line:#e5e7eb;
  --success:#16a34a;
  --pending:#f59e0b;
  --text:#1f2937;
  --muted:#6b7280;
  --whatsapp:#25D366;
}

body{margin:0;padding:12px;background:var(--bg);font-family:"Inter", "Segoe UI", sans-serif;color:var(--text);}
header{display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;}
h1{font-size:18px; color:var(--brand); margin:0;}

/* TABLE STYLING */
.table-card{background:var(--card); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); overflow:hidden;}
table{width:100%; border-collapse:collapse;}
th{background:#f8fafc; color:var(--muted); padding:12px; font-size:11px; text-transform:uppercase; letter-spacing:1px; text-align:left; border-bottom:2px solid var(--line);}
td{padding:14px 12px; font-size:14px; border-bottom:1px solid var(--line);}

/* ACTIONS */
.status-pill{padding:4px 8px; border-radius:6px; font-size:11px; font-weight:700; text-transform:uppercase;}
.pill-wait{background:#fef3c7; color:#92400e;}
.pill-converted{background:#dcfce7; color:#166534;}

.name-link{color:var(--brand); font-weight:700; cursor:pointer; text-decoration:none; border-bottom:1px dashed var(--brand);}
.phone-link{color:var(--accent); text-decoration:none; font-weight:600; display:flex; align-items:center; gap:5px;}

/* MODAL / POPUP */
.modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; backdrop-filter:blur(4px);}
.modal-content{background:#fff; max-width:450px; margin:5vh auto; border-radius:20px; position:relative; overflow:hidden; animation: slideUp 0.3s ease-out;}
@keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }

.modal-header{padding:20px; background:var(--brand); color:#fff; display:flex; justify-content:space-between; align-items:center;}
.modal-body{padding:20px; max-height:70vh; overflow-y:auto;}

.detail-item{margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;}
.detail-label{font-size:10px; color:var(--muted); text-transform:uppercase; font-weight:700; margin-bottom:2px;}
.detail-value{font-size:15px; color:var(--text); font-weight:500;}

/* CHIP SELECTION */
.status-selector{margin-top:10px; display:flex; gap:10px;}
.chip{padding:8px 16px; border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; border:1px solid var(--line); transition:0.2s;}
.chip.active-wait{background:#f59e0b; color:white; border-color:#f59e0b;}
.chip.active-done{background:var(--success); color:white; border-color:var(--success);}

.wa-action-btn{width:100%; background:var(--whatsapp); color:white; border:none; padding:14px; border-radius:12px; font-weight:700; margin-top:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;}

@media(max-width:600px){
    table thead{display:none;}
    table tr{display:block; padding:15px; border-bottom:8px solid var(--bg);}
    table td{display:flex; justify-content:space-between; padding:5px 0; border:none;}
    table td::before{content:attr(data-label); font-size:11px; color:var(--muted); font-weight:700; text-transform:uppercase;}
}
</style>
</head>

<body>

<header>
    <h1>Enrollment Requests</h1>
    <a href="index.html" style="text-decoration:none; font-size:12px; font-weight:700; color:var(--muted);"><i class="fa-solid fa-arrow-left"></i> BACK</a>
</header>

<div class="table-card">
    <table>
        <thead>
            <tr>
                <th>Status</th>
                <th>Date</th>
                <th>Subscriber Name</th>
                <th>Mobile (Click to Call)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<div class="modal" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalName" style="margin:0; font-size:18px;">Details</h2>
            <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-body">
            <div id="modalDetailsContainer"></div>
            
            <label class="detail-label">Update Status</label>
            <div class="status-selector">
                <div class="chip" id="chipWait" onclick="updateStatusUI('Wait')">In Wait</div>
                <div class="chip" id="chipDone" onclick="updateStatusUI('Converted')">Converted</div>
            </div>

            <button class="wa-action-btn" onclick="sendWhatsAppPopup()">
                <i class="fa-brands fa-whatsapp"></i> Send Professional Message
            </button>
        </div>
    </div>
</div>

<script>
// Authentication Check
if(sessionStorage.getItem("adminAuth")!=="true"){ location.href="index.html"; }

let headers = [], fullData = [], activeIdx = null;

function normalizeMobile(r){
    if(!r) return "";
    let d = r.toString().replace(/\D/g,"");
    return d.length === 10 ? "91" + d : d;
}

function formatDate(v){
    const d = new Date(v);
    return isNaN(d) ? v : d.toLocaleDateString("en-GB", {day:"2-digit", month:"short"});
}

function closeModal(){ document.getElementById('detailModal').style.display='none'; }

function openRequest(idx){
    activeIdx = idx;
    const row = fullData[idx];
    const container = document.getElementById('modalDetailsContainer');
    document.getElementById('modalName').innerText = row["Full Name"];
    
    let html = "";
    Object.keys(row).forEach(key => {
        if(key === "Status" || key === "Timestamp") return;
        html += `<div class="detail-item">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${row[key] || "â€”"}</div>
                 </div>`;
    });
    container.innerHTML = html;

    const status = row["Status"];
    document.getElementById('chipWait').className = status === 'Wait' ? 'chip active-wait' : 'chip';
    document.getElementById('chipDone').className = status === 'Converted' ? 'chip active-done' : 'chip';

    document.getElementById('detailModal').style.display = 'block';
}

function updateStatusUI(newStatus) {
    fullData[activeIdx]["Status"] = newStatus;
    renderTable();
    document.getElementById('chipWait').className = newStatus === 'Wait' ? 'chip active-wait' : 'chip';
    document.getElementById('chipDone').className = newStatus === 'Converted' ? 'chip active-done' : 'chip';
}

// Fix 2: Professional WhatsApp Template Integration
function sendWhatsAppPopup() {
    const row = fullData[activeIdx];
    const mobile = normalizeMobile(row["Mobile Number"]);
    
    // Mapping spreadsheet data to template placeholders
    const name = row["Full Name"] ? row["Full Name"].toUpperCase() : "STUDENT";
    const branch = row["Preferred Branch"] || "Study ZONE Branch";
    const plan = row["Preferred Plan"] || "Selected Plan";
    const sDate = row["Start Date"] || "TBD";
    const eDate = row["End Date"] || "TBD";
    const fees = row["Total Fees Payable"] || "0";

    const msg = `Namaste ${name} ðŸ™

Greetings from Study ZONE.

We have received your enrollment request. Please find the details below for your reference:

ðŸ“Œ Enrollment Summary
* Preferred Branch: ${branch}
* Preferred Plan: ${plan}
* Start Date: ${sDate}
* End Date: ${eDate}
* Total Fees Payable: â‚¹${fees}

To confirm your seat, kindly complete the payment using the QR code shared separately.

For any assistance, feel free to reach out to us.

Warm regards,  
Study ZONE`;

    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, "_blank");
}

function renderTable() {
    const body = document.getElementById('tableBody');
    body.innerHTML = "";
    fullData.forEach((row, i) => {
        const statusClass = row["Status"] === "Converted" ? "pill-converted" : "pill-wait";
        const statusText = row["Status"] === "Converted" ? "Converted" : "In Wait";
        
        body.innerHTML += `
            <tr>
                <td data-label="Status"><span class="status-pill ${statusClass}">${statusText}</span></td>
                <td data-label="Date">${formatDate(row["Timestamp"])}</td>
                <td data-label="Subscriber"><a class="name-link" onclick="openRequest(${i})">${row["Full Name"]}</a></td>
                <td data-label="Mobile">
                    <a href="tel:${row["Mobile Number"]}" class="phone-link">
                        <i class="fa-solid fa-phone"></i> ${row["Mobile Number"]}
                    </a>
                </td>
            </tr>
        `;
    });
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
        fullData = results.data.filter(r => r["Full Name"]).reverse();
        renderTable();
    }
});
</script>

</body>
</html>