<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Enrollment Requests</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --brand:#1f3c88;
  --bg:#f4f7fc;
  --card:#ffffff;
  --muted:#6b7280;
  --line:#e5e7eb;
  --whatsapp:#25D366;
}

*{box-sizing:border-box}

body{
  font-family: "Segoe UI", system-ui, Arial;
  background:var(--bg);
  margin:0;
  padding:18px;
  color:#111827;
}

h1{
  text-align:center;
  color:var(--brand);
  margin-bottom:18px;
  font-size:22px;
  letter-spacing:.3px;
}

/* TABLE */
.table-card{
  background:var(--card);
  border-radius:10px;
  box-shadow:0 8px 22px rgba(0,0,0,.06);
  overflow:hidden;
}

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:var(--brand);
  color:#fff;
  padding:14px 12px;
  font-size:14px;
  text-align:left;
  white-space:nowrap;
}

td{
  padding:13px 12px;
  border-bottom:1px solid var(--line);
  font-size:14px;
}

tr:hover{
  background:#eef3ff;
}

.name-link{
  color:var(--brand);
  font-weight:600;
  cursor:pointer;
  text-decoration:underline;
}

.phone-actions a{
  margin-left:8px;
  font-size:16px;
  text-decoration:none;
}

.call{color:var(--brand)}
.whatsapp{color:var(--whatsapp)}

/* MODAL */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  z-index:1000;
}

.modal-content{
  background:#fff;
  max-width:820px;
  margin:3% auto;
  border-radius:12px;
  max-height:90vh;
  display:flex;
  flex-direction:column;
}

.modal-header{
  padding:16px 18px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal-header h2{
  margin:0;
  color:var(--brand);
  font-size:18px;
}

.close-btn{
  font-size:22px;
  cursor:pointer;
  color:#374151;
}

.modal-body{
  padding:18px;
  overflow-y:auto;
}

.detail-row{
  display:flex;
  gap:14px;
  padding:9px 0;
  border-bottom:1px dashed var(--line);
}

.detail-row span{
  min-width:260px;
  font-weight:600;
  color:var(--muted);
}

.action-box{
  margin-top:22px;
  padding-top:16px;
  border-top:2px solid #eef2ff;
}

.whatsapp-btn{
  background:var(--whatsapp);
  color:#fff;
  border:none;
  padding:11px 16px;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

@media(max-width:600px){
  .detail-row{flex-direction:column}
  .detail-row span{min-width:auto}
}
</style>
</head>

<body>

<h1>Enrollment Requests</h1>

<div class="table-card">
<table>
<thead>
<tr>
  <th>Date</th>
  <th>Full Name</th>
  <th>Mobile Number</th>
  <th>Member Type</th>
  <th>Preferred Branch</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<!-- MODAL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Enrollment Details</h2>
      <span class="close-btn" onclick="closeModal()">Ã—</span>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
/* AUTH CHECK */
if(sessionStorage.getItem("adminAuth")!=="true"){
  alert("Unauthorized Access");
  location.href="index.html";
}

let headers=[], selected={};

/* DATE FORMAT */
function formatDate(val){
  const d=new Date(val);
  if(isNaN(d)) return val || "â€”";
  return d.toLocaleDateString("en-GB",{
    day:"2-digit",month:"short",year:"numeric"
  });
}

/* PROFESSIONAL INDIAN WHATSAPP MESSAGE */
function buildWhatsAppMessage(data){
  return `Namaste ${data["Full Name"]} ðŸ™

Greetings from *Study ZONE*.

We are pleased to inform you that we have received your enrollment request. Please find the details below for your reference:

ðŸ“Œ *Enrollment Summary*
â€¢ Preferred Branch: ${data["Preferred Branch"]}
â€¢ Preferred Plan: ${data["Preferred Plan"]}
â€¢ Start Date: ${formatDate(data["Start Date"])}
â€¢ End Date: ${formatDate(data["End Date"])}
â€¢ Total Fees Payable: â‚¹${data["Grand Estimated Cost"]}

To confirm your seat, kindly complete the payment using the QR code shared separately.

In case you require any clarification or assistance, please feel free to contact us. We will be happy to assist you.

Warm regards,  
*Study ZONE*  
Academic Support Team`;
}

/* SEND WHATSAPP (POPUP) */
function sendWhatsApp(){
  const msg = buildWhatsAppMessage(selected);
  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
}

/* SEND WHATSAPP (TABLE ICON) */
function sendRowWhatsApp(row){
  let data={};
  headers.forEach((h,i)=>data[h]=row[i]||"");
  const msg = buildWhatsAppMessage(data);
  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
}

/* MODAL */
function openModal(row){
  selected={};
  headers.forEach((h,i)=>selected[h]=row[i]||"");

  let html="";
  headers.forEach((h,i)=>{
    const v=h.toLowerCase().includes("date") || h.toLowerCase().includes("timestamp")
      ? formatDate(row[i]) : (row[i]||"â€”");
    html+=`
      <div class="detail-row">
        <span>${h}</span>
        <div>${v}</div>
      </div>`;
  });

  html+=`
  <div class="action-box">
    <button class="whatsapp-btn" onclick="sendWhatsApp()">
      <i class="fa-brands fa-whatsapp"></i>
      Send WhatsApp Confirmation
    </button>
  </div>`;

  modalBody.innerHTML=html;
  detailModal.style.display="block";
}

function closeModal(){
  detailModal.style.display="none";
}

/* LOAD SHEET */
Papa.parse(
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv",
{
  download:true,
  skipEmptyLines:true,
  complete:res=>{
    [headers,...rows]=res.data;

    const idx=k=>headers.findIndex(h=>h.toLowerCase().includes(k));
    const iDate=idx("timestamp"),
          iName=idx("name"),
          iMob=idx("mobile"),
          iMem=idx("member"),
          iBr =idx("branch");

    rows.reverse().forEach(row=>{
      let mobile=row[iMob]||"";
      let digits=mobile.replace(/\D/g,"");
      if(digits.length===10) digits="91"+digits;

      tableBody.innerHTML+=`
      <tr>
        <td>${formatDate(row[iDate])}</td>
        <td class="name-link" onclick='openModal(${JSON.stringify(row)})'>
          ${row[iName]}
        </td>
        <td>
          ${mobile}
          ${digits.length===12?`
          <span class="phone-actions">
            <a class="call" href="tel:+${digits}">
              <i class="fa-solid fa-phone"></i>
            </a>
            <a class="whatsapp" href="javascript:void(0)"
               onclick='sendRowWhatsApp(${JSON.stringify(row)})'>
              <i class="fa-brands fa-whatsapp"></i>
            </a>
          </span>`:""}
        </td>
        <td>${row[iMem]||"â€”"}</td>
        <td>${row[iBr]||"â€”"}</td>
      </tr>`;
    });
  }
});
</script>

</body>
</html>
