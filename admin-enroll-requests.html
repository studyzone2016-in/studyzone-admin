<script>
const csvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv";

const writeBackUrl =
"https://script.google.com/macros/s/AKfycbxiKaOnBVXs1B2kdU28QfpPoOPt2gUIQyMqa80tTezAF3L09b6bbIXE6LNPoYr8YozU1A/exec";

Papa.parse(csvUrl, {
  download: true,
  skipEmptyLines: true,
  complete: function(results) {

    const data = results.data;
    if (!data || data.length < 2) return;

    const headers = data[0];
    const dataRows = data.slice(1);

    const headerEl = document.getElementById("tableHeader");
    const bodyEl = document.getElementById("tableBody");

    let statusIndex = -1;

    headers.forEach((h, i) => {
      if (h.toLowerCase().includes("status")) statusIndex = i;
      const th = document.createElement("th");
      th.textContent = h;
      headerEl.appendChild(th);
    });

    /* Latest first, correct row mapping */
    dataRows.slice().reverse().forEach((row, displayIndex) => {
      const actualSheetRow = dataRows.length - displayIndex + 2; // âœ… FIXED

      const tr = document.createElement("tr");

      row.forEach((cell, i) => {
        const td = document.createElement("td");

        if (i === statusIndex) {
          const select = document.createElement("select");
          const currentStatus = cell || "Pending";

          ["Pending","Contacted","Converted","Closed"].forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            if (currentStatus === opt) o.selected = true;
            select.appendChild(o);
          });

          select.onchange = () =>
            updateStatus(actualSheetRow, select.value, td);

          td.appendChild(select);
          applyStatusColor(td, currentStatus);
        } else {
          td.textContent = cell || "";
        }

        tr.appendChild(td);
      });

      bodyEl.appendChild(tr);
    });
  }
});

function applyStatusColor(td, status) {
  td.className = "";
  td.classList.add("status-" + status.toLowerCase());
}

function updateStatus(row, status, td) {
  fetch(writeBackUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "updateStatus",
      row: row,
      status: status
    })
  })
  .then(res => res.json())
  .then(r => console.log("Status updated:", r))
  .catch(err => console.error("Update failed:", err));

  applyStatusColor(td, status);
}
</script>