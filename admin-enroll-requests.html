<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Requests Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --brand:#1f3c88;
  --bg:#f4f7fc;
  --card:#fff;
  --line:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --whatsapp:#25D366;
}

body{margin:0;padding:12px;background:var(--bg);font-family:"Inter", "Segoe UI", sans-serif;color:var(--text);}
header{display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;}
h1{font-size:18px; color:var(--brand); margin:0;}

.table-card{background:var(--card); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); overflow:hidden;}
table{width:100%; border-collapse:collapse;}
th{background:#f8fafc; color:var(--muted); padding:12px; font-size:11px; text-transform:uppercase; letter-spacing:1px; text-align:left; border-bottom:2px solid var(--line);}
td{padding:14px 12px; font-size:14px; border-bottom:1px solid var(--line);}

.name-link{color:var(--brand); font-weight:700; cursor:pointer; text-decoration:none; border-bottom:1px dashed var(--brand);}
.phone-link{color:var(--brand); text-decoration:none; font-weight:600; display:flex; align-items:center; gap:5px;}

.modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; backdrop-filter:blur(4px);}
.modal-content{background:#fff; max-width:450px; margin:5vh auto; border-radius:20px; position:relative; overflow:hidden; animation: slideUp 0.3s ease-out;}
@keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }

.modal-header{padding:20px; background:var(--brand); color:#fff; display:flex; justify-content:space-between; align-items:center;}
.modal-body{padding:20px; max-height:70vh; overflow-y:auto;}

.detail-item{margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;}
.detail-label{font-size:10px; color:var(--muted); text-transform:uppercase; font-weight:700; margin-bottom:2px;}
.detail-value{font-size:15px; color:var(--text); font-weight:500;}

.wa-action-btn{width:100%; background:var(--whatsapp); color:white; border:none; padding:14px; border-radius:12px; font-weight:700; margin-top:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;}

@media(max-width:600px){
    table thead{display:none;}
    table tr{display:block; padding:15px; border-bottom:8px solid var(--bg);}
    table td{display:flex; justify-content:space-between; padding:5px 0; border:none;}
    table td::before{content:attr(data-label); font-size:11px; color:var(--muted); font-weight:700; text-transform:uppercase; margin-right: 10px;}
}
</style>
</head>
<body>

<header>
    <h1>Enrollment Requests</h1>
    <a href="index.html" style="text-decoration:none; font-size:12px; font-weight:700; color:var(--muted);"><i class="fa-solid fa-arrow-left"></i> BACK</a>
</header>

<div class="table-card">
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Subscriber Name</th>
                <th>Mobile Number</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="modal" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalName" style="margin:0; font-size:18px;">Details</h2>
            <span style="cursor:pointer; font-size:24px;" onclick="closeModal()">Ã—</span>
        </div>
        <div class="modal-body">
            <div id="modalDetailsContainer"></div>
            <button class="wa-action-btn" onclick="sendWhatsAppPopup()">
                <i class="fa-brands fa-whatsapp"></i> Send Professional Message
            </button>
        </div>
    </div>
</div>

<script>
// Authentication Check
if(sessionStorage.getItem("adminAuth")!=="true"){ location.href="index.html"; }

let fullData = [], activeIdx = null;

function normalizeMobile(r){
    if(!r) return "";
    let d = r.toString().replace(/\D/g,"");
    return d.length === 10 ? "91" + d : d;
}

/**
 * FIXED DATE LOGIC: Force DD MMM YYYY
 */
function formatTrendDate(v) {
    if (!v || v === "â€”") return "â€”";
    let d;
    
    // Check if string is in DD/MM/YYYY format
    if (typeof v === 'string' && v.includes('/')) {
        const parts = v.split(/[\/\s:]/);
        // Map: Day=parts[0], Month=parts[1]-1, Year=parts[2]
        d = new Date(parts[2], parts[1] - 1, parts[0]);
    } else {
        d = new Date(v);
    }

    if (isNaN(d.getTime())) return v;

    return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
    }).replace(/,/g, ""); 
}

function closeModal(){ document.getElementById('detailModal').style.display='none'; }

function openRequest(idx){
    activeIdx = idx;
    const row = fullData[idx];
    const container = document.getElementById('modalDetailsContainer');
    document.getElementById('modalName').innerText = row["Full Name"] || "Details";
    
    let html = "";
    Object.keys(row).forEach(key => {
        if(key === "Status" || key === "Timestamp") return;
        
        let val = row[key];
        // Format any column name that contains the word "Date"
        if(key.toLowerCase().includes("date")) {
            val = formatTrendDate(val);
        }

        html += `<div class="detail-item">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${val || "â€”"}</div>
                 </div>`;
    });
    container.innerHTML = html;
    document.getElementById('detailModal').style.display = 'block';
}

function sendWhatsAppPopup() {
    const row = fullData[activeIdx];
    const mobile = normalizeMobile(row["Mobile Number"]);
    const name = (row["Full Name"] || "Student").trim().toUpperCase();
    
    const msg = `Namaste *${name}* ðŸ™

Greetings from *Study ZONE*. 

We have received your enrollment request. Please find your summary below:

ðŸ“Œ *ENROLLMENT SUMMARY*
â€¢ *Preferred Branch:* ${row["Preferred Branch"] || "â€”"}
â€¢ *Preferred Plan:* ${row["Preferred Plan"] || "â€”"}
â€¢ *Start Date:* ${formatTrendDate(row["Start Date"])}
â€¢ *No. of Days to Book:* ${row["No. of Days to Book"] || "â€”"}
â€¢ *End Date:* ${formatTrendDate(row["End Date"])}

ðŸ’³ *FEE STRUCTURE*
â€¢ Estimated Cost: â‚¹${row["Estimated Cost"] || "0"}
â€¢ Registration Fees: â‚¹${row["Registration Fees"] || "0"}
â€¢ *Grand Estimated Cost: â‚¹${row["Grand Estimated Cost"] || "0"}*

To confirm your seat, kindly complete the payment using the QR code shared separately.

Warm regards,  
*Study ZONE*`;

    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, "_blank");
}

function renderTable() {
    const body = document.getElementById('tableBody');
    body.innerHTML = "";
    fullData.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="Date">${formatTrendDate(row["Timestamp"])}</td>
            <td data-label="Subscriber"><a class="name-link" onclick="openRequest(${i})">${row["Full Name"] || "Unnamed"}</a></td>
            <td data-label="Mobile">
                <a href="tel:${row["Mobile Number"]}" class="phone-link">
                    <i class="fa-solid fa-phone"></i> ${row["Mobile Number"] || "â€”"}
                </a>
            </td>
        `;
        body.appendChild(tr);
    });
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
        fullData = results.data.filter(r => r["Full Name"]).reverse();
        renderTable();
    }
});
</script>

</body>
</html>