// Authentication Check
if(sessionStorage.getItem("adminAuth")!=="true"){ location.href="index.html"; }

let fullData = [], activeIdx = null;

function normalizeMobile(r){
    if(!r) return "";
    let d = r.toString().replace(/\D/g,"");
    return d.length === 10 ? "91" + d : d;
}

/**
 * FIXED DATE LOGIC
 * Supports DD MMM YYYY format
 */
function formatTrendDate(v) {
    if (!v || v === "â€”") return "â€”";
    
    let d;
    // Handle Google Sheets/CSV dates that might be strings like "31/12/2023"
    if (typeof v === 'string' && v.includes('/')) {
        const parts = v.split(/[\/\s:]/); // Split by slash, space, or colon
        // Assuming DD/MM/YYYY format from the source
        d = new Date(parts[2], parts[1] - 1, parts[0]);
    } else {
        d = new Date(v);
    }

    if (isNaN(d.getTime())) return v;

    // Use 'en-GB' to ensure Day comes before Month
    // Result format: 04 Feb 2026
    return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
    }).replace(/,/g, ""); 
}

function closeModal(){ document.getElementById('detailModal').style.display='none'; }

function openRequest(idx){
    activeIdx = idx;
    const row = fullData[idx];
    const container = document.getElementById('modalDetailsContainer');
    document.getElementById('modalName').innerText = row["Full Name"] || "Details";
    
    let html = "";
    Object.keys(row).forEach(key => {
        if(key === "Status" || key === "Timestamp") return;
        
        let val = row[key];
        // Automatically format any key containing "Date"
        if(key.toLowerCase().includes("date")) {
            val = formatTrendDate(val);
        }

        html += `<div class="detail-item">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${val || "â€”"}</div>
                 </div>`;
    });
    container.innerHTML = html;
    document.getElementById('detailModal').style.display = 'block';
}

function sendWhatsAppPopup() {
    const row = fullData[activeIdx];
    const mobile = normalizeMobile(row["Mobile Number"]);
    
    const name = (row["Full Name"] || "Student").trim().toUpperCase();
    const branch = row["Preferred Branch"] || "â€”";
    const plan = row["Preferred Plan"] || "â€”";
    
    // Applying the fix to WhatsApp variables
    const startDate = formatTrendDate(row["Start Date"]);
    const endDate = formatTrendDate(row["End Date"]);
    
    const days = row["No. of Days to Book"] || "â€”";
    const estCost = row["Estimated Cost"] || "0";
    const regFee = row["Registration Fees"] || "0";
    const grandTotal = row["Grand Estimated Cost"] || "0";

    const msg = `Namaste *${name}* ðŸ™

Greetings from *Study ZONE*. 

We have received your enrollment request. Please find your summary below:

ðŸ“Œ *ENROLLMENT SUMMARY*
â€¢ *Preferred Branch:* ${branch}
â€¢ *Preferred Plan:* ${plan}
â€¢ *Start Date:* ${startDate}
â€¢ *No. of Days to Book:* ${days}
â€¢ *End Date:* ${endDate}

ðŸ’³ *FEE STRUCTURE*
â€¢ Estimated Cost: â‚¹${estCost}
â€¢ Registration Fees: â‚¹${regFee}
â€¢ *Grand Estimated Cost: â‚¹${grandTotal}*

To confirm your seat, kindly complete the payment using the QR code shared separately.

For any assistance, feel free to reach out to us.

Warm regards,  
*Study ZONE*`;

    window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(msg)}`, "_blank");
}

function renderTable() {
    const body = document.getElementById('tableBody');
    body.innerHTML = "";
    fullData.forEach((row, i) => {
        body.innerHTML += `
            <tr>
                <td data-label="Date">${formatTrendDate(row["Timestamp"])}</td>
                <td data-label="Subscriber"><a class="name-link" onclick="openRequest(${i})">${row["Full Name"] || "Unnamed"}</a></td>
                <td data-label="Mobile">
                    <a href="tel:${row["Mobile Number"]}" class="phone-link">
                        <i class="fa-solid fa-phone"></i> ${row["Mobile Number"] || "â€”"}
                    </a>
                </td>
            </tr>
        `;
    });
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSC3P-2fO5c0kdG-rE4A9d3V54wNwH4CH6q6kM_eUqjTMr4P228wCmYZr4MtP6UN7BBoyQcWw4kc1Sy/pub?gid=0&single=true&output=csv", {
    download: true,
    header: true,
    complete: function(results) {
        fullData = results.data.filter(r => r["Full Name"]).reverse();
        renderTable();
    }
});