<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Subscriptions</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #007BFF; color: white; }
  select { padding: 5px; margin-right: 10px; }
  .whatsapp { color: green; font-weight: bold; text-decoration: none; }
</style>
</head>
<body>

<h1>Study ZONE | Upcoming Expiry Subscriptions</h1>

<div>
  <label for="centerFilter">Center:</label>
  <select id="centerFilter"><option value="">All</option></select>

  <label for="planFilter">Plan:</label>
  <select id="planFilter"><option value="">All</option></select>
</div>

<table id="subscriptionTable">
  <thead>
    <tr>
      <th>Employee Code</th>
      <th>Full Name</th>
      <th>Phone</th>
      <th>Access Expiry</th>
      <th>Plan</th>
      <th>Center</th>
      <th>WhatsApp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let subscriptions = [];

// Fetch CSV and parse
Papa.parse(csvUrl, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    subscriptions = results.data;
    populateFilters();
    renderTable();
  }
});

// Populate Center and Plan filters dynamically
function populateFilters() {
  const centers = [...new Set(subscriptions.map(s => s.Center).filter(Boolean))];
  const plans = [...new Set(subscriptions.map(s => s.Plan).filter(Boolean))];

  const centerSelect = document.getElementById("centerFilter");
  centers.forEach(c => centerSelect.innerHTML += `<option value="${c}">${c}</option>`);

  const planSelect = document.getElementById("planFilter");
  plans.forEach(p => planSelect.innerHTML += `<option value="${p}">${p}</option>`);

  centerSelect.addEventListener("change", renderTable);
  planSelect.addEventListener("change", renderTable);
}

// Render filtered table
function renderTable() {
  const centerFilter = document.getElementById("centerFilter").value;
  const planFilter = document.getElementById("planFilter").value;
  const tbody = document.querySelector("#subscriptionTable tbody");
  tbody.innerHTML = "";

  const filtered = subscriptions.filter(s => {
    return (centerFilter === "" || s.Center === centerFilter) &&
           (planFilter === "" || s.Plan === planFilter);
  });

  filtered.forEach(s => {
    const phone = s.Phone ? s.Phone.replace(/\s+/g, '') : "";
    const whatsappLink = phone ? `https://wa.me/91${phone}?text=${encodeURIComponent(`ðŸ”” Renewal Alert: Access Ends on ${s['Access Expiry (DD-MM-YY)']} - after 10:00 PM`)}` : "#";
    tbody.innerHTML += `
      <tr>
        <td>${s['Employee Code'] || ""}</td>
        <td>${s['Full Name'] || ""}</td>
        <td>${s.Phone || ""}</td>
        <td>${s['Access Expiry (DD-MM-YY)'] || ""}</td>
        <td>${s.Plan || ""}</td>
        <td>${s.Center || ""}</td>
        <td>${phone ? `<a class="whatsapp" href="${whatsappLink}" target="_blank">WhatsApp</a>` : ""}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>