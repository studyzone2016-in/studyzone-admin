<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Upcoming Expiry Subscriptions</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 16px;
}

.top-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.back-btn {
  background: #0d6efd;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}

h2 {
  margin: 12px 0;
  color: #333;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 14px;
}

select {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.table-container {
  overflow-x: auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

table {
  width: 100%;
  min-width: 700px;
  border-collapse: collapse;
}

thead {
  background: #1f2937;
  color: #fff;
}

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
  white-space: nowrap;
}

tr:hover {
  background: #f9fafb;
}

.expiry {
  color: #dc2626;
  font-weight: 600;
}

.whatsapp-link {
  color: #16a34a;
  font-weight: 600;
  text-decoration: none;
}
</style>
</head>

<body>

<script>
if (sessionStorage.getItem("adminAuth") !== "true") {
  alert("Unauthorized Access");
  window.location.href = "index.html";
}
</script>

<div class="top-bar">
  <button class="back-btn" onclick="location.href='index.html'">‚Üê Back</button>
</div>

<h2>Upcoming Expiry Subscriptions</h2>

<div class="filters">
  <select id="dateFilter">
    <option value="">All Expiry Dates</option>
  </select>

  <select id="centerFilter">
    <option value="">All Centers</option>
  </select>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Access Expiry</th>
        <th>Center</th>
        <th>Full Name</th>
        <th>Plan</th>
        <th>Phone (WhatsApp)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let rawData = [];

Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    rawData = results.data.filter(r =>
      r.Active_Status === "Active" &&
      r.Expiry_Clean &&
      !isNaN(parseInt(r.Days_To_Expiry)) &&
      parseInt(r.Days_To_Expiry) >= 0
    );

    populateFilters();
    renderTable(rawData);
  }
});

function populateFilters() {
  const dateSet = new Set();
  const centerSet = new Set();

  rawData.forEach(r => {
    dateSet.add(r.Expiry_Clean);
    centerSet.add(r.Center);
  });

  [...dateSet].sort().forEach(d =>
    dateFilter.innerHTML += `<option value="${d}">${d}</option>`
  );

  [...centerSet].sort().forEach(c =>
    centerFilter.innerHTML += `<option value="${c}">${c}</option>`
  );
}

dateFilter.onchange = centerFilter.onchange = applyFilters;

function applyFilters() {
  const d = dateFilter.value;
  const c = centerFilter.value;

  const filtered = rawData.filter(r =>
    (!d || r.Expiry_Clean === d) &&
    (!c || r.Center === c)
  );

  renderTable(filtered);
}

/* üîπ NEW: Date parser for sorting */
function parseDate(val) {
  const p = val.split("-");
  const year = p[2].length === 2 ? "20" + p[2] : p[2];
  return new Date(year, p[1] - 1, p[0]);
}

function renderTable(data) {
  tableBody.innerHTML = "";

  /* üîπ NEW: Sort latest expiry first */
  data.sort((a, b) =>
    parseDate(b.Expiry_Clean) - parseDate(a.Expiry_Clean)
  );

  data.forEach(r => {
    const msg = `üîî Renewal Alert: Access Ends on ${r.Expiry_Clean} - after 10:00 PM`;
    const phone = r.Phone.replace(/\D/g, "");
    const wa = `https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`;

    tableBody.innerHTML += `
      <tr>
        <td class="expiry">${r.Expiry_Clean}</td>
        <td>${r.Center}</td>
        <td>${r["Full Name"]}</td>
        <td>${r.Plan}</td>
        <td>
          <a class="whatsapp-link" href="${wa}" target="_blank">
            ${r.Phone}
          </a>
        </td>
      </tr>
    `;
  });
}
</script>

</body>
</html>