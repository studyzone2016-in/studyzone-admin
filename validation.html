<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study ZONE - Revenue Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7f6; margin: 20px; color: #333; }
        .controls-container { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .back-btn { padding: 10px 20px; background-color: #2c3e50; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; }
        .date-picker-wrap { display: flex; align-items: center; gap: 10px; }
        input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #2c3e50; color: #fff; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .highlight { font-weight: bold; color: #27ae60; }
        .summary-row { background-color: #ecf0f1 !important; font-weight: bold; font-size: 1.1em; }
        #loading { font-size: 1.2em; color: #e67e22; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="controls-container">
        <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
        <div class="date-picker-wrap">
            <label for="dateSelect"><strong>Select Date:</strong></label>
            <input type="date" id="dateSelect">
        </div>
    </div>

    <h2 id="viewTitle">Admissions for Selected Date</h2>
    <p id="loading">Loading data...</p>

    <table id="dataTable" style="display: none;">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Phone</th>
                <th>Created</th>
                <th>Joining</th>
                <th>Expiry</th>
                <th>Center</th>
                <th>Plan</th>
                <th>Days</th>
                <th>Daily Rate</th>
                <th>Reg. Fee</th>
                <th>Total (Rs)</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr class="summary-row">
                <td colspan="10" style="text-align: right;">Grand Total:</td>
                <td id="totalRevenue" class="highlight">Rs 0</td>
            </tr>
        </tfoot>
    </table>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";
        let csvData = [];

        // Set default date to today in Input
        const dateInput = document.getElementById('dateSelect');
        const now = new Date();
        dateInput.value = now.toISOString().split('T')[0];

        function parseCustomDate(dateStr) {
            if (!dateStr) return null;
            let parts = dateStr.trim().split(/[-/]/);
            if (parts.length !== 3) return null;
            let d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
            if (y < 100) y += 2000;
            let parsed = new Date(y, m, d);
            parsed.setHours(0, 0, 0, 0);
            return parsed;
        }

        function calculateRate(center, plan) {
            plan = (plan || "").trim();
            center = (center || "").trim();
            if (center === 'SZ04') {
                if (plan === 'Full Day') return 94;
                if (['Evening Batch', 'Afternoon Batch', 'Morning Batch'].includes(plan)) return 54;
                if (['Morning + Evening Batch', 'Morning + Afternoon Batch', 'Afternoon + Evening Batch'].includes(plan)) return 74;
                if (plan === 'Day Plan') return 250;
                if (plan.includes('Mini Batch')) return 40;
                if (plan === 'Weekend Spl') return 66.67;
            } else if (['SZ03', 'SZ01'].includes(center)) {
                if (plan === 'Full Day') return 60;
                if (['Evening Batch', 'Afternoon Batch', 'Morning Batch'].includes(plan)) return 40;
                if (['Morning + Evening Batch', 'Morning + Afternoon Batch', 'Afternoon + Evening Batch'].includes(plan)) return 50;
                if (plan === 'Day Plan') return 150;
                if (plan.includes('Mini Batch')) return 25;
                if (plan === 'Weekend Spl') return 41.67;
            }
            return 0;
        }

        function updateDisplay() {
            const selectedDate = new Date(dateInput.value);
            selectedDate.setHours(0, 0, 0, 0);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let grandTotal = 0;
            let found = false;

            csvData.forEach(row => {
                const createdDate = parseCustomDate(row["Created (DD-MM-YY)"]);
                const joiningDate = parseCustomDate(row["Joining Date (DD-MM-YY)"]);
                const expiryDate = parseCustomDate(row["Access Expiry (DD-MM-YY)"]);

                const matchCreated = createdDate && createdDate.getTime() === selectedDate.getTime();
                const matchJoining = joiningDate && joiningDate.getTime() === selectedDate.getTime();

                if (matchCreated || matchJoining) {
                    found = true;
                    let days = 0;
                    if (joiningDate && expiryDate) {
                        days = Math.floor((expiryDate - joiningDate) / (1000 * 60 * 60 * 24)) + 1;
                    }
                    if (days < 0) days = 0;

                    const rate = calculateRate(row["Center"], row["Plan"]);
                    let regFee = matchCreated ? 175 : 0;
                    let total = (rate * days) + regFee;
                    grandTotal += total;

                    tbody.innerHTML += `
                        <tr>
                            <td>${row["Full Name"] || 'N/A'}</td>
                            <td>${row["Phone"] || 'N/A'}</td>
                            <td>${row["Created (DD-MM-YY)"] || 'N/A'}</td>
                            <td>${row["Joining Date (DD-MM-YY)"] || 'N/A'}</td>
                            <td>${row["Access Expiry (DD-MM-YY)"] || 'N/A'}</td>
                            <td>${row["Center"] || 'N/A'}</td>
                            <td>${row["Plan"] || 'N/A'}</td>
                            <td>${days}</td>
                            <td>Rs ${rate.toFixed(2)}</td>
                            <td>Rs ${regFee}</td>
                            <td class="highlight">Rs ${Math.round(total)}</td>
                        </tr>`;
                }
            });

            document.getElementById('totalRevenue').innerText = `Rs ${Math.round(grandTotal)}`;
            if (!found) tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;">No records for this date.</td></tr>';
        }

        Papa.parse(CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                csvData = results.data;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                updateDisplay();
            }
        });

        dateInput.addEventListener('change', updateDisplay);
    </script>
</body>
</html>