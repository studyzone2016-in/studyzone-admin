<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Revenue & Calculation Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 20px;
            color: #333;
        }
        h2 {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #2c3e50;
            color: #fff;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .highlight {
            font-weight: bold;
            color: #27ae60;
        }
        #loading {
            font-size: 1.2em;
            color: #e67e22;
        }
    </style>
</head>
<body>

    <h2>Calculated Admissions for Today</h2>
    <p id="loading">Fetching and processing data...</p>

    <table id="dataTable" style="display: none;">
        <thead>
            <tr>
                <th>Created Date</th>
                <th>Joining Date</th>
                <th>Access Expiry Date</th>
                <th>Center</th>
                <th>Plan</th>
                <th>Days Counted</th>
                <th>Rate Applied (per day)</th>
                <th>Registration Fee</th>
                <th>Total Amount (Rs)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

        // Helper function to parse dates formatted as DD-MM-YY or DD/MM/YY
        function parseCustomDate(dateStr) {
            if (!dateStr) return null;
            // Split by hyphen or slash
            let parts = dateStr.trim().split(/[-/]/);
            if (parts.length !== 3) return null;
            
            let d = parseInt(parts[0], 10);
            let m = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
            let y = parseInt(parts[2], 10);
            
            // Handle 2-digit years
            if (y < 100) y += 2000; 

            let parsedDate = new Date(y, m, d);
            parsedDate.setHours(0, 0, 0, 0);
            return parsedDate;
        }

        // Get today's date stripped of time for accurate comparison
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        function isSameDay(d1, d2) {
            return d1 && d2 && d1.getTime() === d2.getTime();
        }

        function calculateRate(center, plan) {
            plan = plan ? plan.trim() : "";
            center = center ? center.trim() : "";

            let rate = 0;

            if (center === 'SZ04') {
                if (plan === 'Full Day') rate = 94;
                else if (['Evening Batch', 'Afternoon Batch', 'Morning Batch'].includes(plan)) rate = 54;
                else if (['Morning + Evening Batch', 'Morning + Afternoon Batch', 'Afternoon + Evening Batch'].includes(plan)) rate = 74;
                else if (plan === 'Day Plan') rate = 250;
                else if (plan.includes('Mini Batch')) rate = 40;
                else if (plan === 'Weekend Spl') rate = 66.66666666666667;
            } 
            else if (center === 'SZ03' || center === 'SZ01') {
                if (plan === 'Full Day') rate = 60;
                else if (['Evening Batch', 'Afternoon Batch', 'Morning Batch'].includes(plan)) rate = 40;
                else if (['Morning + Evening Batch', 'Morning + Afternoon Batch', 'Afternoon + Evening Batch'].includes(plan)) rate = 50;
                else if (plan === 'Day Plan') rate = 150;
                else if (plan.includes('Mini Batch')) rate = 25;
                else if (plan === 'Weekend Spl') rate = 41.66666666666667;
            }

            return rate;
        }

        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                const tbody = document.getElementById('tableBody');
                let foundRecords = false;

                data.forEach(row => {
                    // Extract data from standard column headers
                    const createdStr = row["Created (DD-MM-YY)"];
                    const joiningStr = row["Joining Date (DD-MM-YY)"];
                    const expiryStr = row["Access Expiry (DD-MM-YY)"];
                    const center = row["Center"];
                    const plan = row["Plan"];

                    const createdDate = parseCustomDate(createdStr);
                    const joiningDate = parseCustomDate(joiningStr);
                    const expiryDate = parseCustomDate(expiryStr);

                    const isCreatedToday = isSameDay(createdDate, today);
                    const isJoiningToday = isSameDay(joiningDate, today);

                    // Condition: ONLY process if Created OR Joining is Today
                    if (isCreatedToday || isJoiningToday) {
                        foundRecords = true;

                        // Calculate Days: (Expiry - Joining) + 1 inclusive day
                        let days = 0;
                        if (joiningDate && expiryDate) {
                            const msPerDay = 1000 * 60 * 60 * 24;
                            days = Math.floor((expiryDate - joiningDate) / msPerDay) + 1;
                        }
                        if (days < 0) days = 0; // Fallback for illogical dates

                        // Derive Rate and Base Amount
                        const dailyRate = calculateRate(center, plan);
                        let totalAmount = dailyRate * days;

                        // Add Rs 175 Registration Fee if Created Today
                        let regFee = 0;
                        if (isCreatedToday) {
                            regFee = 175;
                            totalAmount += regFee;
                        }

                        // Generate Table Row
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${createdStr || 'N/A'}</td>
                            <td>${joiningStr || 'N/A'}</td>
                            <td>${expiryStr || 'N/A'}</td>
                            <td>${center || 'N/A'}</td>
                            <td>${plan || 'N/A'}</td>
                            <td>${days}</td>
                            <td>Rs ${dailyRate.toFixed(2)}</td>
                            <td>Rs ${regFee}</td>
                            <td class="highlight">Rs ${Math.round(totalAmount)}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';

                if (!foundRecords) {
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No records match today's date criteria.</td></tr>`;
                }
            },
            error: function(err) {
                document.getElementById('loading').innerText = "Error loading data. Make sure the Google Sheet is published to the web.";
                console.error(err);
            }
        });
    </script>
</body>
</html>