<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 10px; }

.top-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
}

.dropdown {
  position: relative;
  min-width: 180px;
}

.drop-btn {
  width: 100%;
  padding: 7px 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  text-align: left;
  border-radius: 4px;
}

.drop-btn::after {
  content: "â–¾";
  float: right;
}

.drop-list {
  display: none;
  position: absolute;
  top: 110%;
  left: 0;
  z-index: 999;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
  max-height: 220px;
  overflow-y: auto;
  width: 100%;
}

.drop-list label {
  display: block;
  padding: 7px 10px;
  font-size: 14px;
  cursor: pointer;
}

.drop-list label:hover {
  background: #f4f6f8;
}

input[type="text"] {
  padding: 7px;
  font-size: 14px;
}

.count-box {
  background: #f2f2f2;
  border: 1px solid #ccc;
  padding: 7px 14px;
  font-weight: bold;
  border-radius: 4px;
}

.table-wrap {
  overflow-x: auto;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  min-width: 900px;
  width: 100%;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
  text-align: center;
  white-space: nowrap;
}

th { background: #f2f2f2; }

.call-btn { background: #4CAF50; color: #fff; border: none; padding:4px 8px; }
.wa-btn { background: #25D366; color: #fff; border: none; padding:4px 8px; }
.disabled { opacity: .4; pointer-events: none; }
</style>
</head>

<body>

<div class="top-bar">
  <button onclick="history.back()">â¬… Back</button>
  <h3>Active Members</h3>
</div>

<div class="filters">

  <div class="dropdown">
    <div class="drop-btn" onclick="toggleDrop('feesList')">Fees Status</div>
    <div class="drop-list" id="feesList"></div>
  </div>

  <div class="dropdown">
    <div class="drop-btn" onclick="toggleDrop('centerList')">Center</div>
    <div class="drop-list" id="centerList"></div>
  </div>

  <div class="dropdown">
    <div class="drop-btn" onclick="toggleDrop('planList')">Plan</div>
    <div class="drop-list" id="planList"></div>
  </div>

  <input type="text" id="nameSearch" placeholder="Search Full Name">

  <div class="count-box">
    Total: <span id="resultCount">0</span>
  </div>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Center</th>
  <th>Plan</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Call</th>
  <th>WhatsApp</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let allRows = [], idxGlobal = null;

function normalizePhone(raw) {
  if (!raw) return null;
  let p = raw.replace(/\D/g,"");
  if (p.startsWith("91") && p.length > 10) p = p.slice(-10);
  return /^\d{10}$/.test(p) ? p : null;
}

fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
  const rows=parseCSV(csv);
  const headers=rows.shift();

  idxGlobal={
    fees:headers.indexOf("Fees Status"),
    center:headers.indexOf("Center"),
    plan:headers.indexOf("Plan"),
    name:headers.indexOf("Full Name"),
    phone:headers.indexOf("Phone"),
    join:headers.indexOf("Joining Date (DD-MM-YY)"),
    expiry:headers.indexOf("Access Expiry (DD-MM-YY)")
  };

  const today=new Date(); today.setHours(0,0,0,0);

  allRows=rows.filter(r=>{
    const e=r[idxGlobal.expiry];
    if(!e) return false;
    const [dd,mm,yy]=e.split("-");
    return new Date(`20${yy}`,mm-1,dd)>=today;
  });

  buildDropdown("feesList",idxGlobal.fees);
  buildDropdown("centerList",idxGlobal.center);
  buildDropdown("planList",idxGlobal.plan);
  render();
});

function toggleDrop(id){
  const el=document.getElementById(id);
  const open=el.style.display==="block";
  closeAll();
  if(!open) el.style.display="block";
}

function closeAll(){
  document.querySelectorAll(".drop-list").forEach(d=>d.style.display="none");
}

function buildDropdown(id,col){
  const box=document.getElementById(id);
  [...new Set(allRows.map(r=>r[col]).filter(Boolean))].forEach(v=>{
    const l=document.createElement("label");
    l.innerHTML=`<input type="checkbox" value="${v}"> ${v}`;
    l.querySelector("input").onchange=render;
    box.appendChild(l);
  });
}

function selected(id){
  return [...document.querySelectorAll(`#${id} input:checked`)].map(c=>c.value);
}

function render(){
  tableBody.innerHTML="";
  const f=selected("feesList"),
        c=selected("centerList"),
        p=selected("planList"),
        q=nameSearch.value.toLowerCase();

  const data=allRows.filter(r=>{
    if(f.length && !f.includes(r[idxGlobal.fees])) return false;
    if(c.length && !c.includes(r[idxGlobal.center])) return false;
    if(p.length && !p.includes(r[idxGlobal.plan])) return false;
    if(q && !r[idxGlobal.name].toLowerCase().includes(q)) return false;
    return true;
  });

  resultCount.innerText=data.length;

  data.forEach(r=>{
    const ph=normalizePhone(r[idxGlobal.phone]);
    const msg=encodeURIComponent(`ðŸ”” Renewal Alert: Access Ends on ${r[idxGlobal.expiry]} - after 10:00 PM`);

    tableBody.innerHTML+=`
    <tr>
      <td>${r[idxGlobal.name]}</td>
      <td>${r[idxGlobal.center]}</td>
      <td>${r[idxGlobal.plan]}</td>
      <td>${r[idxGlobal.join]}</td>
      <td>${r[idxGlobal.expiry]}</td>
      <td>${ph?`<button class="call-btn" onclick="location.href='tel:${ph}'">Call</button>`:`<button class="call-btn disabled">Call</button>`}</td>
      <td>${ph?`<button class="wa-btn" onclick="location.href='https://wa.me/91${ph}?text=${msg}'">WhatsApp</button>`:`<button class="wa-btn disabled">WhatsApp</button>`}</td>
    </tr>`;
  });
}

document.addEventListener("click",e=>{
  if(!e.target.closest(".dropdown")) closeAll();
});
nameSearch.oninput=render;

function parseCSV(t){
  const r=[],row=[],c={v:""},q={v:false};
  for(let x of t){
    if(x=='"') q.v=!q.v;
    else if(x==","&&!q.v){row.push(c.v);c.v="";}
    else if(x=="\n"&&!q.v){row.push(c.v);r.push([...row]);row.length=0;c.v="";}
    else c.v+=x;
  }
  row.push(c.v); r.push([...row]);
  return r;
}
</script>

</body>
</html>