<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 10px; }

.top-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.back-btn { padding: 6px 10px; cursor: pointer; }

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 10px;
}

.filter-box {
  border: 1px solid #ccc;
  padding: 6px;
  max-height: 160px;
  overflow-y: auto;
  min-width: 160px;
}

.filter-box b { display: block; margin-bottom: 4px; }

input[type="text"] { padding: 6px; font-size: 14px; }

.table-wrapper {
  overflow: auto;
  max-height: 75vh;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  min-width: 900px;
  width: 100%;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #f2f2f2;
  position: sticky;
  top: 0;
}

button.call {
  background: #4CAF50;
  color: #fff;
  border: none;
  padding: 5px 8px;
}

button.whatsapp {
  background: #25D366;
  color: #fff;
  border: none;
  padding: 5px 8px;
}
</style>
</head>

<body>

<div class="top-bar">
  <button class="back-btn" onclick="location.href='index.html'">â¬… Back</button>
  <h3>Active Members</h3>
</div>

<div class="filters">
  <div class="filter-box" id="centerFilter"><b>Center</b></div>
  <div class="filter-box" id="planFilter"><b>Plan</b></div>
  <input type="text" id="nameSearch" placeholder="Search Full Name">
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Call</th>
  <th>WhatsApp</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let allRows = [];
let selectedCenters = new Set();
let selectedPlans = new Set();

/* ---------- Robust CSV Parser ---------- */
function parseCSV(text) {
  const rows = [];
  let row = [], val = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];
    if (c === '"' && inQuotes && n === '"') { val += '"'; i++; }
    else if (c === '"') inQuotes = !inQuotes;
    else if (c === "," && !inQuotes) { row.push(val); val = ""; }
    else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (val || row.length) row.push(val);
      if (row.length) rows.push(row);
      row = []; val = "";
    } else val += c;
  }
  if (val || row.length) { row.push(val); rows.push(row); }
  return rows;
}

function parseDMY(v) {
  const p = v.split("-");
  if (p.length !== 3) return null;
  return new Date(p[2], p[1] - 1, p[0]);
}

fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
    const data = parseCSV(csv);
    const headers = data.shift().map(h => h.trim());

    const idx = {
      center: headers.findIndex(h => h.startsWith("Center")),
      plan: headers.findIndex(h => h.startsWith("Plan")),
      name: headers.findIndex(h => h.startsWith("Full Name")),
      phone: headers.findIndex(h => h.startsWith("Phone")),
      join: headers.findIndex(h => h.startsWith("Joining")),
      expiry: headers.findIndex(h => h.startsWith("Access Expiry")),
      fees: headers.findIndex(h => h.startsWith("Fees"))
    };

    const today = new Date(); today.setHours(0,0,0,0);

    allRows = data.filter(r => {
      if (!r[idx.expiry]) return false;
      const d = parseDMY(r[idx.expiry]);
      return d && d >= today;
    });

    initFilters(idx);
    renderTable(idx);
  });

function initFilters(idx) {
  buildFilter("centerFilter", idx.center, selectedCenters, idx);
  buildFilter("planFilter", idx.plan, selectedPlans, idx);
  document.getElementById("nameSearch").oninput = () => renderTable(idx);
}

function buildFilter(divId, col, set, idx) {
  const div = document.getElementById(divId);
  [...new Set(allRows.map(r => r[col]).filter(Boolean))].forEach(v => {
    const l = document.createElement("label");
    l.style.display = "block";
    l.innerHTML = `<input type="checkbox"> ${v}`;
    l.querySelector("input").onchange = e => {
      e.target.checked ? set.add(v) : set.delete(v);
      renderTable(idx);
    };
    div.appendChild(l);
  });
}

function renderTable(idx) {
  const body = document.getElementById("tableBody");
  body.innerHTML = "";

  const q = document.getElementById("nameSearch").value.toLowerCase();

  allRows.filter(r => {
    if (selectedCenters.size && !selectedCenters.has(r[idx.center])) return false;
    if (selectedPlans.size && !selectedPlans.has(r[idx.plan])) return false;
    if (q && !r[idx.name].toLowerCase().includes(q)) return false;
    return true;
  }).forEach(r => {
    const phone = r[idx.phone].replace(/\D/g, "");
    const msg = encodeURIComponent(
      `ðŸ”” Renewal Alert: Access Ends on ${r[idx.expiry]} - after 10:00 PM`
    );

    body.innerHTML += `
      <tr>
        <td>${r[idx.name]}</td>
        <td>${r[idx.phone]}</td>
        <td>${r[idx.join]}</td>
        <td>${r[idx.expiry]}</td>
        <td>${r[idx.fees]}</td>
        <td><button class="call" onclick="location.href='tel:${phone}'">Call</button></td>
        <td><button class="whatsapp"
          onclick="location.href='https://wa.me/91${phone}?text=${msg}'">WhatsApp</button></td>
      </tr>`;
  });
}
</script>

</body>
</html>