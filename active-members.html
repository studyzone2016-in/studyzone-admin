<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
}

.top-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

button {
  padding: 6px 10px;
  cursor: pointer;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 10px;
  align-items: center;
}

select {
  padding: 6px;
  font-size: 14px;
  min-width: 170px;
  height: 100px;
}

input {
  padding: 6px;
  font-size: 14px;
}

.count-box {
  background: #f2f2f2;
  border: 1px solid #ccc;
  padding: 6px 12px;
  font-weight: bold;
  border-radius: 4px;
}

.table-wrap {
  overflow-x: auto;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  min-width: 900px;
  width: 100%;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #f2f2f2;
}

.call-btn {
  background: #4CAF50;
  color: #fff;
  border: none;
}

.wa-btn {
  background: #25D366;
  color: #fff;
  border: none;
}

.wa-btn:disabled {
  background: #aaa;
  cursor: not-allowed;
}
</style>
</head>

<body>

<div class="top-bar">
  <button onclick="history.back()">â¬… Back</button>
  <h3>Active Members</h3>
</div>

<div class="filters">
  <select id="centerFilter" multiple></select>
  <select id="planFilter" multiple></select>

  <input type="text" id="nameSearch" placeholder="Search Full Name">

  <button onclick="resetFilters()">Reset</button>

  <div class="count-box">
    Total: <span id="resultCount">0</span>
  </div>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Call</th>
  <th>WhatsApp</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let allRows = [];

fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = parseCSV(csv);
    const headers = rows.shift();

    const idx = {
      center: headers.indexOf("Center"),
      plan: headers.indexOf("Plan"),
      name: headers.indexOf("Full Name"),
      phone: headers.indexOf("Phone"),
      join: headers.indexOf("Joining Date (DD-MM-YY)"),
      expiry: headers.indexOf("Access Expiry (DD-MM-YY)"),
      fees: headers.indexOf("Fees Status")
    };

    const today = new Date();
    today.setHours(0,0,0,0);

    allRows = rows.filter(r => {
      const e = r[idx.expiry];
      if (!e) return false;
      const [dd, mm, yy] = e.split("-");
      const d = new Date(`20${yy}`, mm - 1, dd);
      return d >= today;
    });

    populateFilters(idx);
    render(idx);
  });

function populateFilters(idx) {
  const centers = [...new Set(allRows.map(r => r[idx.center]).filter(Boolean))];
  const plans = [...new Set(allRows.map(r => r[idx.plan]).filter(Boolean))];

  centerFilter.innerHTML = `<option value="ALL">Entire Selection</option>`;
  planFilter.innerHTML = `<option value="ALL">Entire Selection</option>`;

  centers.forEach(c =>
    centerFilter.innerHTML += `<option value="${c}">${c}</option>`
  );
  plans.forEach(p =>
    planFilter.innerHTML += `<option value="${p}">${p}</option>`
  );

  centerFilter.onchange = () => handleSelect(centerFilter, idx);
  planFilter.onchange = () => handleSelect(planFilter, idx);
  nameSearch.oninput = () => render(idx);

  centerFilter.options[0].selected = true;
  planFilter.options[0].selected = true;
}

function handleSelect(select, idx) {
  const allOption = select.options[0];

  if (allOption.selected && select.selectedOptions.length > 1) {
    [...select.options].forEach(o => o.selected = false);
    allOption.selected = true;
  } else if (!allOption.selected && select.selectedOptions.length > 0) {
    allOption.selected = false;
  }
  render(idx);
}

function resetFilters() {
  [...centerFilter.options].forEach(o => o.selected = false);
  [...planFilter.options].forEach(o => o.selected = false);
  centerFilter.options[0].selected = true;
  planFilter.options[0].selected = true;
  nameSearch.value = "";
  render(currentIdx);
}

let currentIdx;
function render(idx) {
  currentIdx = idx;
  tableBody.innerHTML = "";

  const centers = getSelected(centerFilter);
  const plans = getSelected(planFilter);
  const q = nameSearch.value.toLowerCase();

  const filtered = allRows.filter(r => {
    if (!centers.includes("ALL") && !centers.includes(r[idx.center])) return false;
    if (!plans.includes("ALL") && !plans.includes(r[idx.plan])) return false;
    if (q && !r[idx.name].toLowerCase().includes(q)) return false;
    return true;
  });

  resultCount.innerText = filtered.length;

  filtered.forEach(r => {
    const raw = r[idx.phone] || "";
    const phone = raw.replace(/\D/g, "");
    const validPhone = phone.length === 10;

    const msg = encodeURIComponent(
      `ðŸ”” Renewal Alert: Access Ends on ${r[idx.expiry]} - after 10:00 PM`
    );

    tableBody.innerHTML += `
    <tr>
      <td>${r[idx.name]}</td>
      <td>${raw}</td>
      <td>${r[idx.join]}</td>
      <td>${r[idx.expiry]}</td>
      <td>${r[idx.fees]}</td>
      <td>
        ${validPhone
          ? `<button class="call-btn" onclick="location.href='tel:${phone}'">Call</button>`
          : ""}
      </td>
      <td>
        ${validPhone
          ? `<button class="wa-btn" onclick="location.href='https://wa.me/${phone}?text=${msg}'">WhatsApp</button>`
          : `<button class="wa-btn" disabled>WhatsApp</button>`}
      </td>
    </tr>`;
  });
}

function getSelected(select) {
  return [...select.selectedOptions].map(o => o.value);
}

/* Robust CSV parser */
function parseCSV(text) {
  const rows = [];
  let row = [], cur = "", inside = false;

  for (let c of text) {
    if (c === '"') inside = !inside;
    else if (c === "," && !inside) {
      row.push(cur); cur = "";
    } else if (c === "\n" && !inside) {
      row.push(cur);
      rows.push(row);
      row = []; cur = "";
    } else {
      cur += c;
    }
  }
  row.push(cur);
  rows.push(row);
  return rows;
}
</script>

</body>
</html>