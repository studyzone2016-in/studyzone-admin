<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 10px; background:#f5f6fa; }
.top-bar { display:flex; flex-direction:column; gap:10px; }

.filter-box {
  background:#fff; border:1px solid #ccc; border-radius:6px;
  padding:8px;
}

.filter-title {
  font-weight:bold;
  cursor:pointer;
}

.filter-options {
  display:none;
  margin-top:6px;
  max-height:180px;
  overflow-y:auto;
}

.filter-options label {
  display:block;
  font-size:14px;
  padding:4px 0;
}

button {
  padding:8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.reset { background:#dc3545; color:#fff; }

.count-box {
  background:#0d6efd;
  color:#fff;
  padding:10px;
  border-radius:6px;
  font-weight:bold;
  text-align:center;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
}

th, td {
  padding:8px;
  border-bottom:1px solid #ddd;
  font-size:13px;
}

th {
  background:#343a40;
  color:#fff;
  position:sticky;
  top:0;
}

.actions button { font-size:12px; margin-right:4px; }
.call { background:#198754; color:#fff; }
.wa { background:#25D366; color:#fff; }
</style>
</head>

<body>

<div class="top-bar">

  <div class="filter-box">
    <div class="filter-title" onclick="toggle('centerBox')">üìç Select Center</div>
    <div class="filter-options" id="centerBox"></div>
  </div>

  <div class="filter-box">
    <div class="filter-title" onclick="toggle('planBox')">üì¶ Select Plan</div>
    <div class="filter-options" id="planBox"></div>
  </div>

  <button class="reset" onclick="resetAll()">üîÑ Reset Filters</button>

  <div class="count-box" id="countBox">Total Members: 0</div>
</div>

<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

/* üîí LOCKED COLUMN INDEX */
const COL = {
  CENTER: 0,
  PLAN: 1,
  NAME: 2,
  PHONE: 3,
  JOIN: 4,
  EXPIRY: 5,
  FEES: 6
};

let rows = [];

function toggle(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}

function cleanPhone(p) {
  p = p.replace(/\D/g,'');
  if (p.startsWith("91") && p.length > 10) p = p.slice(-10);
  return p.length === 10 ? p : "";
}

fetch(CSV_URL)
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n").map(r => r.split(","));
    lines.shift(); // header
    rows = lines;
    buildFilters();
    applyFilters();
  });

function buildFilters() {
  const centers = [...new Set(rows.map(r => r[COL.CENTER]))];
  const plans = [...new Set(rows.map(r => r[COL.PLAN]))];

  const cBox = document.getElementById("centerBox");
  const pBox = document.getElementById("planBox");

  cBox.innerHTML = `<label><input type="checkbox" onclick="selectAll(this,'center')"> Entire Selection</label>`;
  centers.forEach(c =>
    cBox.innerHTML += `<label><input type="checkbox" class="center" value="${c}" onchange="applyFilters()"> ${c}</label>`
  );

  pBox.innerHTML = `<label><input type="checkbox" onclick="selectAll(this,'plan')"> Entire Selection</label>`;
  plans.forEach(p =>
    pBox.innerHTML += `<label><input type="checkbox" class="plan" value="${p}" onchange="applyFilters()"> ${p}</label>`
  );
}

function selectAll(src, cls) {
  document.querySelectorAll(`.${cls}`).forEach(cb => cb.checked = src.checked);
  applyFilters();
}

function getSelected(cls) {
  return [...document.querySelectorAll(`.${cls}:checked`)].map(cb => cb.value);
}

function applyFilters() {
  const cSel = getSelected("center");
  const pSel = getSelected("plan");

  const filtered = rows.filter(r =>
    (cSel.length === 0 || cSel.includes(r[COL.CENTER])) &&
    (pSel.length === 0 || pSel.includes(r[COL.PLAN]))
  );

  render(filtered);
  document.getElementById("countBox").innerText =
    `Total Members: ${filtered.length}`;
}

function resetAll() {
  document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked=false);
  applyFilters();
}

function render(data) {
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  data.forEach(r => {
    const phone = cleanPhone(r[COL.PHONE]);
    tb.innerHTML += `
      <tr>
        <td>${r[COL.NAME]}</td>
        <td>${phone || "Invalid"}</td>
        <td>${r[COL.JOIN]}</td>
        <td>${r[COL.EXPIRY]}</td>
        <td>${r[COL.FEES]}</td>
        <td class="actions">
          ${phone ? `
            <a href="tel:${phone}"><button class="call">Call</button></a>
            <a href="https://wa.me/${phone}" target="_blank">
              <button class="wa">WA</button>
            </a>` : ""}
        </td>
      </tr>`;
  });
}
</script>

</body>
</html>