<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
}

.top-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}

.back-btn {
  padding: 6px 10px;
  cursor: pointer;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 12px 0;
}

select, input {
  padding: 6px;
  font-size: 14px;
}

.table-wrap {
  overflow-x: auto;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 900px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #f2f2f2;
}

.call-btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 5px 8px;
}

.wa-btn {
  background: #25D366;
  color: white;
  border: none;
  padding: 5px 8px;
}
</style>
</head>

<body>

<div class="top-bar">
  <button class="back-btn" onclick="history.back()">â¬… Back</button>
  <h3>Active Members</h3>
</div>

<div class="filters">
  <select id="centerFilter">
    <option value="">All Centers</option>
  </select>

  <select id="planFilter">
    <option value="">All Plans</option>
  </select>

  <input type="text" id="nameSearch" placeholder="Search Full Name">
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Call</th>
  <th>WhatsApp</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
/* ðŸ”´ UPDATE THESE TWO VALUES ONLY */
const SHEET_ID = "PUT_YOUR_SHEET_ID_HERE";
const GID = "0";

const URL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;

let allData = [];

fetch(URL)
  .then(r => r.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const headers = json.table.cols.map(c => c.label);
    const rows = json.table.rows;

    const col = h => headers.indexOf(h);

    const today = new Date();
    today.setHours(0,0,0,0);

    allData = rows.map(r => ({
      center: r.c[col("Center")]?.v || "",
      plan: r.c[col("Plan")]?.v || "",
      name: r.c[col("Full Name")]?.v || "",
      phone: r.c[col("Phone")]?.v || "",
      join: r.c[col("Joining Date (DD-MM-YY)")]?.v || "",
      expiry: r.c[col("Access Expiry (DD-MM-YY)")]?.v || "",
      fees: r.c[col("Fees Status")]?.v || ""
    })).filter(r => {
      if (!r.expiry) return false;
      const [dd, mm, yy] = r.expiry.split("-");
      const d = new Date(`20${yy}`, mm - 1, dd);
      return d >= today;
    });

    buildFilters();
    renderTable();
  });

function buildFilters() {
  const centerSet = new Set();
  const planSet = new Set();

  allData.forEach(r => {
    centerSet.add(r.center);
    planSet.add(r.plan);
  });

  centerSet.forEach(c =>
    centerFilter.innerHTML += `<option value="${c}">${c}</option>`
  );
  planSet.forEach(p =>
    planFilter.innerHTML += `<option value="${p}">${p}</option>`
  );

  centerFilter.onchange = renderTable;
  planFilter.onchange = renderTable;
  nameSearch.oninput = renderTable;
}

function renderTable() {
  tableBody.innerHTML = "";

  const cVal = centerFilter.value;
  const pVal = planFilter.value;
  const q = nameSearch.value.toLowerCase();

  allData.filter(r => {
    if (cVal && r.center !== cVal) return false;
    if (pVal && r.plan !== pVal) return false;
    if (q && !r.name.toLowerCase().includes(q)) return false;
    return true;
  }).forEach(r => {
    const phoneClean = r.phone.replace(/\D/g,"");
    const msg = encodeURIComponent(
      `ðŸ”” Renewal Alert: Access Ends on ${r.expiry} - after 10:00 PM`
    );

    tableBody.innerHTML += `
      <tr>
        <td>${r.name}</td>
        <td>${r.phone}</td>
        <td>${r.join}</td>
        <td>${r.expiry}</td>
        <td>${r.fees}</td>
        <td>
          <button class="call-btn"
            onclick="location.href='tel:${phoneClean}'">Call</button>
        </td>
        <td>
          <button class="wa-btn"
            onclick="location.href='https://wa.me/91${phoneClean}?text=${msg}'">
            WhatsApp
          </button>
        </td>
      </tr>`;
  });
}
</script>

</body>
</html>