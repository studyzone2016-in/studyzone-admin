<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 10px;
}

.filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}

.dropdown {
    position: relative;
}

.dropdown button {
    padding: 6px 10px;
    font-size: 14px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background: #fff;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    padding: 5px;
}

.dropdown-content label {
    display: block;
    font-size: 13px;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.count-box {
    font-size: 13px;
    margin-left: 5px;
    color: #555;
}

input[type="text"] {
    padding: 6px;
    font-size: 14px;
}

.table-wrapper {
    overflow: auto;
    max-height: 75vh;
    border: 1px solid #ccc;
}

table {
    border-collapse: collapse;
    min-width: 900px;
    width: 100%;
}

th, td {
    border: 1px solid #ddd;
    padding: 6px;
    font-size: 13px;
    text-align: center;
    white-space: nowrap;
}

th {
    background: #f2f2f2;
    position: sticky;
    top: 0;
}

button.call {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 5px 8px;
    cursor: pointer;
}

button.whatsapp {
    background: #25D366;
    color: white;
    border: none;
    padding: 5px 8px;
    cursor: pointer;
}
</style>
</head>

<body>

<h3>Active Members</h3>

<div class="filters">
    <div class="dropdown">
        <button>Center</button>
        <span class="count-box" id="centerCount">(0)</span>
        <div class="dropdown-content" id="centerFilter"></div>
    </div>

    <div class="dropdown">
        <button>Plan</button>
        <span class="count-box" id="planCount">(0)</span>
        <div class="dropdown-content" id="planFilter"></div>
    </div>

    <input type="text" id="nameSearch" placeholder="Search Full Name">
</div>

<div class="table-wrapper">
<table>
    <thead>
        <tr>
            <th>Full Name</th>
            <th>Phone</th>
            <th>Joining Date</th>
            <th>Access Expiry</th>
            <th>Fees Status</th>
            <th>Call</th>
            <th>WhatsApp</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/gviz/tq?tqx=out:csv";

let allRows = [];
let selectedCenters = new Set();
let selectedPlans = new Set();

fetch(SHEET_URL)
.then(res => res.text())
.then(csv => {
    const rows = csv.split("\n").map(r => r.split(","));
    const headers = rows.shift();

    const idx = {
        center: headers.indexOf("Center"),
        plan: headers.indexOf("Plan"),
        name: headers.indexOf("Full Name"),
        phone: headers.indexOf("Phone"),
        join: headers.indexOf("Joining Date"),
        expiry: headers.indexOf("Access Expiry"),
        fees: headers.indexOf("Fees Status")
    };

    const today = new Date();

    allRows = rows.filter(r => {
        if (!r[idx.expiry]) return false;
        const exp = new Date(r[idx.expiry].split("-").reverse().join("-"));
        return exp >= today;
    });

    initFilters(idx);
    renderTable(idx);
});

function initFilters(idx) {
    const centers = [...new Set(allRows.map(r => r[idx.center]).filter(Boolean))];
    const plans = [...new Set(allRows.map(r => r[idx.plan]).filter(Boolean))];

    const centerDiv = document.getElementById("centerFilter");
    centers.forEach(c => {
        const l = document.createElement("label");
        l.innerHTML = `<input type="checkbox" value="${c}"> ${c}`;
        l.querySelector("input").onchange = e => {
            e.target.checked ? selectedCenters.add(c) : selectedCenters.delete(c);
            renderTable(idx);
        };
        centerDiv.appendChild(l);
    });

    const planDiv = document.getElementById("planFilter");
    plans.forEach(p => {
        const l = document.createElement("label");
        l.innerHTML = `<input type="checkbox" value="${p}"> ${p}`;
        l.querySelector("input").onchange = e => {
            e.target.checked ? selectedPlans.add(p) : selectedPlans.delete(p);
            renderTable(idx);
        };
        planDiv.appendChild(l);
    });

    document.getElementById("nameSearch").oninput = () => renderTable(idx);
}

function renderTable(idx) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    const nameText = document.getElementById("nameSearch").value.toLowerCase();

    let filtered = allRows.filter(r => {
        if (selectedCenters.size && !selectedCenters.has(r[idx.center])) return false;
        if (selectedPlans.size && !selectedPlans.has(r[idx.plan])) return false;
        if (nameText && !r[idx.name].toLowerCase().includes(nameText)) return false;
        return true;
    });

    document.getElementById("centerCount").innerText = `(${filtered.length})`;
    document.getElementById("planCount").innerText = `(${filtered.length})`;

    filtered.forEach(r => {
        const phone = r[idx.phone].replace(/\D/g, "");
        const msg = encodeURIComponent(`ðŸ”” Renewal Alert: Access Ends on ${r[idx.expiry]} - after 10:00 PM`);

        tbody.innerHTML += `
        <tr>
            <td>${r[idx.name]}</td>
            <td>${r[idx.phone]}</td>
            <td>${r[idx.join]}</td>
            <td>${r[idx.expiry]}</td>
            <td>${r[idx.fees]}</td>
            <td><button class="call" onclick="location.href='tel:${phone}'">Call</button></td>
            <td><button class="whatsapp" onclick="location.href='https://wa.me/91${phone}?text=${msg}'">WhatsApp</button></td>
        </tr>`;
    });
}
</script>

</body>
</html>