<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
  background: #f6f7fb;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.dropdown-box {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 8px;
}

.dropdown-header {
  font-weight: bold;
  cursor: pointer;
}

.dropdown-list {
  display: none;
  margin-top: 8px;
  max-height: 180px;
  overflow-y: auto;
}

.dropdown-list label {
  display: block;
  font-size: 14px;
  padding: 4px 0;
}

button {
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.reset-btn {
  background: #d9534f;
  color: #fff;
}

.count-box {
  background: #0d6efd;
  color: #fff;
  padding: 10px;
  border-radius: 6px;
  text-align: center;
  font-weight: bold;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  font-size: 13px;
  text-align: left;
}

th {
  background: #343a40;
  color: #fff;
  position: sticky;
  top: 0;
}

.actions button {
  margin-right: 5px;
  font-size: 12px;
}

.whatsapp {
  background: #25D366;
  color: #fff;
}

.call {
  background: #198754;
  color: #fff;
}
</style>
</head>

<body>

<div class="controls">

  <div class="dropdown-box">
    <div class="dropdown-header" onclick="toggleDropdown('centerList')">
      üìç Select Center(s)
    </div>
    <div class="dropdown-list" id="centerList"></div>
  </div>

  <div class="dropdown-box">
    <div class="dropdown-header" onclick="toggleDropdown('planList')">
      üì¶ Select Plan(s)
    </div>
    <div class="dropdown-list" id="planList"></div>
  </div>

  <button class="reset-btn" onclick="resetFilters()">üîÑ Reset Selection</button>

  <div class="count-box" id="countBox">Total Members: 0</div>
</div>

<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let data = [];

function toggleDropdown(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}

function cleanPhone(phone) {
  phone = phone.replace(/\D/g, "");
  if (phone.startsWith("91") && phone.length > 10) {
    phone = phone.slice(-10);
  }
  return phone.length === 10 ? phone : null;
}

function createCheckbox(listId, value) {
  return `
    <label>
      <input type="checkbox" value="${value}" onchange="applyFilters()"> ${value}
    </label>`;
}

fetch(CSV_URL)
  .then(r => r.text())
  .then(text => {
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows.shift();

    data = rows.map(r => ({
      Center: r[0],
      Plan: r[1],
      Name: r[2],
      Phone: r[3],
      Join: r[4],
      Expiry: r[5],
      Fees: r[6]
    }));

    initFilters();
    applyFilters();
  });

function initFilters() {
  const centers = [...new Set(data.map(d => d.Center))];
  const plans = [...new Set(data.map(d => d.Plan))];

  const centerList = document.getElementById("centerList");
  const planList = document.getElementById("planList");

  centerList.innerHTML = `<label><input type="checkbox" onclick="selectAll('centerList', this)"> Entire Selection</label>`;
  centers.forEach(c => centerList.innerHTML += createCheckbox("centerList", c));

  planList.innerHTML = `<label><input type="checkbox" onclick="selectAll('planList', this)"> Entire Selection</label>`;
  plans.forEach(p => planList.innerHTML += createCheckbox("planList", p));
}

function selectAll(listId, source) {
  document.querySelectorAll(`#${listId} input[type=checkbox]`)
    .forEach(cb => cb.checked = source.checked);
  applyFilters();
}

function getSelected(listId) {
  return [...document.querySelectorAll(`#${listId} input[type=checkbox]:checked`)]
    .map(cb => cb.value)
    .filter(v => v !== "on");
}

function applyFilters() {
  const centers = getSelected("centerList");
  const plans = getSelected("planList");

  let filtered = data.filter(d =>
    (centers.length === 0 || centers.includes(d.Center)) &&
    (plans.length === 0 || plans.includes(d.Plan))
  );

  renderTable(filtered);
  document.getElementById("countBox").innerText =
    `Total Members: ${filtered.length}`;
}

function resetFilters() {
  document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
  applyFilters();
}

function renderTable(rows) {
  const body = document.getElementById("tableBody");
  body.innerHTML = "";

  rows.forEach(r => {
    const phone = cleanPhone(r.Phone);
    body.innerHTML += `
      <tr>
        <td>${r.Name}</td>
        <td>${phone || "Invalid"}</td>
        <td>${r.Join}</td>
        <td>${r.Expiry}</td>
        <td>${r.Fees}</td>
        <td class="actions">
          ${phone ? `
            <a href="tel:${phone}"><button class="call">Call</button></a>
            <a href="https://wa.me/${phone}" target="_blank">
              <button class="whatsapp">WhatsApp</button>
            </a>` : ""}
        </td>
      </tr>`;
  });
}
</script>

</body>
</html>