<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 10px; }

.top-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.dropdown { position: relative; min-width: 170px; }

.drop-btn {
  width: 100%;
  padding: 6px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  text-align: left;
}

.drop-list {
  display: none;
  position: absolute;
  z-index: 20;
  background: #fff;
  border: 1px solid #ccc;
  max-height: 180px;
  overflow-y: auto;
  width: 100%;
}

.drop-list label {
  display: block;
  padding: 6px;
  font-size: 14px;
}

input[type="text"] {
  padding: 6px;
  font-size: 14px;
}

.count-box {
  background: #f2f2f2;
  border: 1px solid #ccc;
  padding: 6px 12px;
  font-weight: bold;
  border-radius: 4px;
}

.table-wrap { overflow-x: auto; border: 1px solid #ccc; }

table {
  border-collapse: collapse;
  min-width: 900px;
  width: 100%;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 13px;
  text-align: center;
  white-space: nowrap;
}

th { background: #f2f2f2; }

.call-btn { background: #4CAF50; color: #fff; border: none; padding:4px 8px; }
.wa-btn { background: #25D366; color: #fff; border: none; padding:4px 8px; }
.disabled { opacity: 0.4; pointer-events: none; }
</style>
</head>

<body>

<div class="top-bar">
  <button onclick="history.back()">â¬… Back</button>
  <h3>Active Members</h3>
</div>

<div class="filters">
  <div class="dropdown">
    <div class="drop-btn" onclick="toggleDrop('centerList')">Select Center</div>
    <div class="drop-list" id="centerList"></div>
  </div>

  <div class="dropdown">
    <div class="drop-btn" onclick="toggleDrop('planList')">Select Plan</div>
    <div class="drop-list" id="planList"></div>
  </div>

  <input type="text" id="nameSearch" placeholder="Search Full Name">

  <div class="count-box">
    Total: <span id="resultCount">0</span>
  </div>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Full Name</th>
  <th>Phone</th>
  <th>Joining Date</th>
  <th>Access Expiry</th>
  <th>Fees Status</th>
  <th>Call</th>
  <th>WhatsApp</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let allRows = [];
let idxGlobal = null;

/* âœ… PHONE NORMALIZATION */
function normalizePhone(raw) {
  if (!raw) return null;
  let p = raw.replace(/\D/g, "");     // digits only
  if (p.startsWith("91") && p.length > 10) {
    p = p.slice(-10);                 // remove 91 prefix
  }
  return /^\d{10}$/.test(p) ? p : null;
}

fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = parseCSV(csv);
    const headers = rows.shift();

    idxGlobal = {
      center: headers.indexOf("Center"),
      plan: headers.indexOf("Plan"),
      name: headers.indexOf("Full Name"),
      phone: headers.indexOf("Phone"),
      join: headers.indexOf("Joining Date (DD-MM-YY)"),
      expiry: headers.indexOf("Access Expiry (DD-MM-YY)"),
      fees: headers.indexOf("Fees Status")
    };

    const today = new Date(); today.setHours(0,0,0,0);

    allRows = rows.filter(r => {
      const e = r[idxGlobal.expiry];
      if (!e) return false;
      const [dd, mm, yy] = e.split("-");
      return new Date(`20${yy}`, mm-1, dd) >= today;
    });

    buildDropdown("centerList", idxGlobal.center);
    buildDropdown("planList", idxGlobal.plan);
    render();
  });

function toggleDrop(id) {
  const el = document.getElementById(id);
  closeAllDropdowns();
  el.style.display = "block";
}

function closeAllDropdowns() {
  document.querySelectorAll(".drop-list").forEach(d => d.style.display = "none");
}

function buildDropdown(id, col) {
  const box = document.getElementById(id);
  [...new Set(allRows.map(r => r[col]).filter(Boolean))].forEach(v => {
    const lbl = document.createElement("label");
    lbl.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
    lbl.querySelector("input").onchange = () => { render(); closeAllDropdowns(); };
    box.appendChild(lbl);
  });
}

function selectedValues(id) {
  return [...document.querySelectorAll(`#${id} input:checked`)].map(cb => cb.value);
}

function render() {
  const idx = idxGlobal;
  tableBody.innerHTML = "";

  const centers = selectedValues("centerList");
  const plans = selectedValues("planList");
  const q = nameSearch.value.toLowerCase();

  const filtered = allRows.filter(r => {
    if (centers.length && !centers.includes(r[idx.center])) return false;
    if (plans.length && !plans.includes(r[idx.plan])) return false;
    if (q && !r[idx.name].toLowerCase().includes(q)) return false;
    return true;
  });

  resultCount.innerText = filtered.length;

  filtered.forEach(r => {
    const cleanPhone = normalizePhone(r[idx.phone]);
    const msg = encodeURIComponent(
      `ðŸ”” Renewal Alert: Access Ends on ${r[idx.expiry]} - after 10:00 PM`
    );

    tableBody.innerHTML += `
      <tr>
        <td>${r[idx.name]}</td>
        <td>${cleanPhone ?? r[idx.phone]}</td>
        <td>${r[idx.join]}</td>
        <td>${r[idx.expiry]}</td>
        <td>${r[idx.fees]}</td>
        <td>
          ${cleanPhone
            ? `<button class="call-btn" onclick="location.href='tel:${cleanPhone}'">Call</button>`
            : `<button class="call-btn disabled">Call</button>`}
        </td>
        <td>
          ${cleanPhone
            ? `<button class="wa-btn" onclick="location.href='https://wa.me/91${cleanPhone}?text=${msg}'">WhatsApp</button>`
            : `<button class="wa-btn disabled">WhatsApp</button>`}
        </td>
      </tr>`;
  });
}

document.addEventListener("click", e => {
  if (!e.target.closest(".dropdown")) closeAllDropdowns();
});

nameSearch.oninput = render;

/* CSV parser */
function parseCSV(text) {
  const rows=[], row=[], cur={v:""}, q={v:false};
  for (let c of text) {
    if (c === '"') q.v = !q.v;
    else if (c === "," && !q.v) { row.push(cur.v); cur.v=""; }
    else if (c === "\n" && !q.v) { row.push(cur.v); rows.push([...row]); row.length=0; cur.v=""; }
    else cur.v += c;
  }
  row.push(cur.v); rows.push([...row]);
  return rows;
}
</script>

</body>
</html>