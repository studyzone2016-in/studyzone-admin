<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study ZONE | Active Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6fb;
    padding: 12px;
  }

  h2 {
    margin-top: 0;
  }

  .back-btn {
    display: inline-block;
    margin-bottom: 10px;
    background: #333;
    color: #fff;
    padding: 6px 10px;
    text-decoration: none;
    border-radius: 4px;
    font-size: 13px;
  }

  .table-wrap {
    overflow: auto;
    max-height: 75vh;
    border: 1px solid #ccc;
    background: #fff;
  }

  table {
    border-collapse: collapse;
    min-width: 850px;
    width: 100%;
    font-size: 14px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    white-space: nowrap;
  }

  th {
    background: #007bff;
    color: #fff;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  tr:nth-child(even) {
    background: #f9f9f9;
  }

  .phone a {
    display: inline-block;
    margin-right: 6px;
    text-decoration: none;
    font-weight: bold;
  }

  .call {
    color: #007bff;
  }

  .wa {
    color: #25D366;
  }

  .status-active {
    color: #2e7d32;
    font-weight: bold;
  }
</style>
</head>

<body>

<a href="index.html" class="back-btn">‚Üê Back</a>
<h2>Active Members</h2>

<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>Full Name</th>
      <th>Phone</th>
      <th>Joining Date</th>
      <th>Access Expiry</th>
      <th>Fees Status</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
</div>

<script>
const csvUrl =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv';

function parseCSV(line){
  const out=[]; let cur='',q=false;
  for(const ch of line){
    if(ch === '"') q=!q;
    else if(ch === ',' && !q){ out.push(cur); cur=''; }
    else cur+=ch;
  }
  out.push(cur);
  return out.map(v=>v.replace(/^"|"$/g,'').trim());
}

function parseDate(v){
  if(!v) return null;
  let [d,m,y]=v.split('-').map(n=>parseInt(n,10));
  if(y < 100) y += 2000;
  const dt = new Date(y,m-1,d);
  return isNaN(dt) ? null : dt;
}

const tbody = document.getElementById('tbody');
const today = new Date();
today.setHours(0,0,0,0);

fetch(csvUrl)
  .then(r=>r.text())
  .then(csv=>{
    const lines = csv.trim().split('\n');
    const h = parseCSV(lines[0]);

    const idx = {
      name: h.findIndex(x=>x.toLowerCase().includes('full')),
      phone: h.findIndex(x=>x.toLowerCase().includes('phone')),
      join: h.findIndex(x=>x.toLowerCase().includes('joining')),
      expiry: h.findIndex(x=>x.toLowerCase().includes('expiry')),
      fees: h.findIndex(x=>x.toLowerCase().includes('fees'))
    };

    const rows = [];

    lines.slice(1).forEach(l=>{
      const c = parseCSV(l);
      const expiryDate = parseDate(c[idx.expiry]);
      if(!expiryDate || expiryDate < today) return; // ACTIVE ONLY

      rows.push({
        name: c[idx.name] || '',
        phone: (c[idx.phone]||'').replace(/\D/g,''),
        join: c[idx.join] || '',
        expiry: c[idx.expiry] || '',
        fees: c[idx.fees] || '',
        date: expiryDate
      });
    });

    // Sort by nearest expiry
    rows.sort((a,b)=>a.date-b.date);

    rows.forEach(r=>{
      const msg = encodeURIComponent(
        `üîî Access valid till ${r.expiry}`
      );
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${r.name}</td>
          <td class="phone">
            ${r.phone}
            <br>
            <a class="call" href="tel:${r.phone}">üìû Call</a>
            <a class="wa" target="_blank"
               href="https://wa.me/${r.phone}?text=${msg}">üí¨ WhatsApp</a>
          </td>
          <td>${r.join}</td>
          <td>${r.expiry}</td>
          <td class="status-active">${r.fees}</td>
        </tr>
      `);
    });
  });
</script>

</body>
</html>