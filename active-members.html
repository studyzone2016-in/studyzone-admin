<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study ZONE | Active Members</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #2563eb;
      --success: #22c55e;
      --wa-green: #25D366;
      --bg-body: #f1f5f9;
      --text-main: #1e293b;
      --border-color: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 16px;
    }

    .header-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 20px auto;
    }

    .toolbar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      max-width: 1200px;
      margin: 0 auto 20px auto;
      border: 1px solid var(--border-color);
    }

    /* BEST ALIGNMENT FOR FILTERS */
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .search-sort-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
      padding-top: 15px;
      border-top: 1px dashed var(--border-color);
    }

    .dropdown { position: relative; }
    .label-tag {
      display: block;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 6px;
    }

    .drop-btn, select, input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .drop-list {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 100;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow);
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
    }

    .drop-list label {
      display: flex;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .drop-list label:hover { background: #f8fafc; }

    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
    }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th { background: #f8fafc; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: #64748b; border-bottom: 1px solid var(--border-color); }
    td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
    
    .badge-plan { background: #eff6ff; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; }
    .btn-group { display: flex; gap: 5px; }
    .action-btn { padding: 6px 10px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 600; }
    .call-btn { background: #e0f2fe; color: #0369a1; }
    .wa-btn { background: #dcfce7; color: #15803d; }

    @media (max-width: 768px) {
      .filter-grid, .search-sort-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="header-area">
  <h3>Active Members</h3>
  <div style="font-weight: 600;">Total: <span id="resultCount" style="color: var(--primary);">0</span></div>
</div>

<div class="toolbar">
  <div class="filter-grid">
    <div class="dropdown">
      <span class="label-tag">Fees Status</span>
      <div class="drop-btn" onclick="toggleDrop('feesList')">Select Status</div>
      <div class="drop-list" id="feesList"></div>
    </div>
    <div class="dropdown">
      <span class="label-tag">Center</span>
      <div class="drop-btn" onclick="toggleDrop('centerList')">All Centers</div>
      <div class="drop-list" id="centerList"></div>
    </div>
    <div class="dropdown">
      <span class="label-tag">Plan</span>
      <div class="drop-btn" onclick="toggleDrop('planList')">All Plans</div>
      <div class="drop-list" id="planList"></div>
    </div>
  </div>

  <div class="search-sort-grid">
    <div>
      <span class="label-tag">Search Name</span>
      <input type="text" id="nameSearch" placeholder="Type student name..." oninput="render()">
    </div>
    <div>
      <span class="label-tag">Sort By</span>
      <select id="sortBy" onchange="render()">
        <option value="expAsc">Expiry (Soonest)</option>
        <option value="expDesc">Expiry (Latest)</option>
        <option value="joinDesc">Joining (Newest)</option>
      </select>
    </div>
  </div>
</div>

<div class="table-container">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Subscriber</th>
          <th>Center</th>
          <th>Current Plan</th>
          <th>Joining</th>
          <th>Expiry</th>
          <th>Days Booked</th>
          <th>Quick Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv";

let allRows=[], idxG=null;

function toDate(v){
  if(!v || v === "--") return new Date(0);
  const [d,m,y]=v.split("-");
  return new Date(`20${y}`, m-1, d);
}

function calcDays(start, end){
  const s = toDate(start), e = toDate(end);
  if(s.getTime() === 0 || e.getTime() === 0) return "--";
  const diff = Math.ceil((e - s) / (1000 * 60 * 60 * 24));
  return diff > 0 ? diff : 0;
}

fetch(CSV_URL).then(r=>r.text()).then(csv=>{
  const lines = csv.trim().split("\n").map(l => l.split(",").map(c => c.replace(/^"|"$/g,'').trim()));
  const headers = lines.shift();

  idxG = {
    fees: headers.indexOf("Fees Status"),
    center: headers.indexOf("Center"),
    plan: headers.indexOf("Plan"),
    name: headers.indexOf("Full Name"),
    phone: headers.indexOf("Phone"),
    join: headers.indexOf("Joining Date (DD-MM-YY)"),
    expiry: headers.indexOf("Access Expiry (DD-MM-YY)")
  };

  const today = new Date(); today.setHours(0,0,0,0);
  allRows = lines.filter(r => toDate(r[idxG.expiry]) >= today);

  buildDrop("feesList", idxG.fees);
  buildDrop("centerList", idxG.center);
  buildDrop("planList", idxG.plan);
  render();
});

function buildDrop(id, col){
  const box = document.getElementById(id);
  [...new Set(allRows.map(r=>r[col]).filter(Boolean))].sort().forEach(v=>{
    const l = document.createElement("label");
    l.innerHTML = `<input type="checkbox" value="${v}"> ${v}`;
    l.querySelector("input").onchange = render;
    box.appendChild(l);
  });
}

function toggleDrop(id){
  const el = document.getElementById(id);
  const isDisp = el.style.display === "block";
  document.querySelectorAll(".drop-list").forEach(d => d.style.display = "none");
  if(!isDisp) el.style.display = "block";
}

function render(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  
  const f = [...document.querySelectorAll("#feesList input:checked")].map(i=>i.value);
  const c = [...document.querySelectorAll("#centerList input:checked")].map(i=>i.value);
  const p = [...document.querySelectorAll("#planList input:checked")].map(i=>i.value);
  const q = document.getElementById("nameSearch").value.toLowerCase();
  const s = document.getElementById("sortBy").value;

  let data = allRows.filter(r => {
    if(f.length && !f.includes(r[idxG.fees])) return false;
    if(c.length && !c.includes(r[idxG.center])) return false;
    if(p.length && !p.includes(r[idxG.plan])) return false;
    if(q && !r[idxG.name].toLowerCase().includes(q)) return false;
    return true;
  });

  data.sort((a,b) => {
    if(s === "expAsc") return toDate(a[idxG.expiry]) - toDate(b[idxG.expiry]);
    if(s === "expDesc") return toDate(b[idxG.expiry]) - toDate(a[idxG.expiry]);
    if(s === "joinDesc") return toDate(b[idxG.join]) - toDate(a[idxG.join]);
  });

  document.getElementById("resultCount").innerText = data.length;

  data.forEach(r => {
    const phone = r[idxG.phone].replace(/\D/g,"").slice(-10);
    const daysBooked = calcDays(r[idxG.join], r[idxG.expiry]);
    
    tbody.innerHTML += `
      <tr>
        <td style="font-weight:700;">${r[idxG.name]}</td>
        <td>${r[idxG.center]}</td>
        <td><span class="badge-plan">${r[idxG.plan]}</span></td>
        <td>${r[idxG.join]}</td>
        <td style="color:#ef4444; font-weight:600;">${r[idxG.expiry]}</td>
        <td style="font-weight:600;">${daysBooked} Days</td>
        <td>
          <div class="btn-group">
            <a href="tel:${phone}" class="action-btn call-btn">Call</a>
            <a href="https://wa.me/91${phone}?text=Hi ${r[idxG.name]}, your Study ZONE access ends on ${r[idxG.expiry]}." target="_blank" class="action-btn wa-btn">WhatsApp</a>
          </div>
        </td>
      </tr>`;
  });
}

document.addEventListener("click", e => { if(!e.target.closest(".dropdown")) document.querySelectorAll(".drop-list").forEach(d => d.style.display = "none"); });
</script>
</body>
</html>