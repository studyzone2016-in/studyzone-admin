<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study ZONE | Analysis Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #2563eb;
      --accent: #f59e0b;
      --bg-body: #f1f5f9;
      --text-main: #1e293b;
      --border: #e2e8f0;
      --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 12px;
      line-height: 1.4;
    }

    .nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .back-btn { text-decoration: none; color: var(--primary); font-weight: 600; font-size: 14px; }
    h2 { margin: 0; font-size: 1.2rem; font-weight: 800; }

    /* SECTION STYLING */
    .section-container { margin-bottom: 40px; }
    .section-heading {
      background: var(--primary);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--card-shadow);
    }
    
    .section-heading.joining { background: #059669; } /* Green for Joinings */

    /* DATA CARDS */
    .data-card {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
    }

    .card-row-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px dashed #e2e8f0;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }

    .name-block { flex: 1; }
    .full-name { font-weight: 800; font-size: 15px; color: #0f172a; display: block; }
    .sub-info { font-size: 11px; color: #64748b; font-weight: 500; }
    
    .phone-link { 
      font-size: 13px; 
      color: var(--primary); 
      text-decoration: none; 
      font-weight: 600;
      background: #eff6ff;
      padding: 4px 8px;
      border-radius: 5px;
    }

    .grid-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }

    .detail-item label {
      display: block;
      font-size: 9px;
      text-transform: uppercase;
      color: #94a3b8;
      font-weight: 700;
      margin-bottom: 1px;
    }

    .detail-item span { font-weight: 600; color: #334155; }
    
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      background: #f1f5f9;
    }
    
    .status-paid { color: #059669; background: #ecfdf5; }
    .status-pending { color: #dc2626; background: #fef2f2; }

    .spacer { height: 20px; border-top: 2px solid #cbd5e1; margin: 30px 0; }
  </style>
</head>
<body>

<div class="nav-header">
  <a href="index.html" class="back-btn">‚Üê Home</a>
  <h2>Data Analysis</h2>
</div>

<div class="section-container">
  <div class="section-heading">üÜï Newly Created Subscribers (By Column E)</div>
  <div id="createdContainer">Loading data...</div>
</div>

<div class="spacer"></div>

<div class="section-container">
  <div class="section-heading joining">üìÖ Joining Date Latest on Top (By Column J)</div>
  <div id="joiningContainer">Loading data...</div>
</div>

<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv';

function parseCSV(line){
  const out=[]; let cur='',qt=false;
  for(const ch of line){
    if(ch=='"') qt=!qt;
    else if(ch==','&&!qt){out.push(cur);cur='';}
    else cur+=ch;
  }
  out.push(cur);
  return out.map(v=>v.replace(/^"|"$/g,'').trim());
}

function parseDate(v){
  if(!v) return new Date(0);
  let [d,m,y]=v.split('-').map(n=>parseInt(n,10));
  if(y<100) y+=2000;
  return new Date(y,m-1,d);
}

fetch(csvUrl).then(r=>r.text()).then(csv=>{
  const lines = csv.trim().split('\n');
  const headers = parseCSV(lines[0]);

  // Map Column Indexes based on your Sheet Structure
  const idx = {
    name: headers.findIndex(x => x.toLowerCase().includes('full')),
    phone: headers.findIndex(x => x.toLowerCase().includes('phone')),
    created: 4, // Column E (0-indexed 4)
    expiry: headers.findIndex(x => x.toLowerCase().includes('expiry')),
    joining: 9, // Column J (0-indexed 9)
    center: headers.findIndex(x => x.toLowerCase().includes('center')),
    fees: headers.findIndex(x => x.toLowerCase().includes('fees')),
    plan: headers.findIndex(x => x.toLowerCase().includes('plan'))
  };

  let rawData = lines.slice(1).map(l => {
    const c = parseCSV(l);
    return {
      name: c[idx.name] || 'N/A',
      phone: (c[idx.phone] || '').replace(/\D/g,'').slice(-10),
      created: c[idx.created] || '',
      createdDate: parseDate(c[idx.created]),
      expiry: c[idx.expiry] || '',
      joining: c[idx.joining] || '',
      joiningDate: parseDate(c[idx.joining]),
      center: c[idx.center] || 'Main',
      fees: c[idx.fees] || 'Pending',
      plan: c[idx.plan] || 'Basic'
    };
  });

  // --- RENDERING SECTION 1 (CREATED DATE) ---
  const createdSort = [...rawData].sort((a,b) => b.createdDate - a.createdDate);
  const createdContainer = document.getElementById('createdContainer');
  createdContainer.innerHTML = '';
  
  createdSort.forEach(r => {
    createdContainer.innerHTML += `
      <div class="data-card">
        <div class="card-row-top">
          <div class="name-block">
            <span class="full-name">${r.name}</span>
            <span class="sub-info">${r.center} ‚Ä¢ ${r.fees}</span>
          </div>
          <a href="tel:${r.phone}" class="phone-link">üìû ${r.phone}</a>
        </div>
        <div class="grid-details">
          <div class="detail-item"><label>Created</label><span>${r.created}</span></div>
          <div class="detail-item"><label>Joining</label><span>${r.joining}</span></div>
          <div class="detail-item"><label>Expiry</label><span>${r.expiry}</span></div>
          <div class="detail-item"><label>Plan</label><span class="badge">${r.plan}</span></div>
        </div>
      </div>`;
  });

  // --- RENDERING SECTION 2 (JOINING DATE) ---
  const joiningSort = [...rawData].sort((a,b) => b.joiningDate - a.joiningDate);
  const joiningContainer = document.getElementById('joiningContainer');
  joiningContainer.innerHTML = '';

  joiningSort.forEach(r => {
    joiningContainer.innerHTML += `
      <div class="data-card">
        <div class="card-row-top">
          <div class="name-block">
            <span class="full-name">${r.name}</span>
            <span class="sub-info">${r.center} ‚Ä¢ ${r.fees}</span>
          </div>
          <a href="tel:${r.phone}" class="phone-link">üìû ${r.phone}</a>
        </div>
        <div class="grid-details">
          <div class="detail-item"><label>Joining Date</label><span style="color:var(--primary)">${r.joining}</span></div>
          <div class="detail-item"><label>Current Plan</label><span class="badge">${r.plan}</span></div>
        </div>
      </div>`;
  });
});
</script>

</body>
</html>