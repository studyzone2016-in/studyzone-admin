<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study ZONE | Data Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #2563eb;
      --bg-body: #f1f5f9;
      --text-main: #1e293b;
      --border: #e2e8f0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0; padding: 12px;
    }

    .nav-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .back-btn { text-decoration: none; color: var(--primary); font-weight: 600; font-size: 14px; }
    h2 { margin: 0; font-size: 1.1rem; }

    /* CONTROLS */
    .filter-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; }
    
    select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 13px;
      outline: none;
    }

    /* CARDS */
    .data-card {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }

    .full-name { font-weight: 800; font-size: 15px; display: block; }
    .sub-details { font-size: 11px; color: #64748b; }
    .phone-btn { font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 600; }

    .grid-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }

    .info-box label { display: block; font-size: 9px; color: #94a3b8; font-weight: 700; }
    .info-box span { font-weight: 600; }

    .no-data { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }
  </style>
</head>
<body>

<div class="nav-header">
  <a href="index.html" class="back-btn">‚Üê Back</a>
  <h2 id="viewTitle">Subscriber Analysis</h2>
</div>

<div class="filter-card">
  <div class="filter-group">
    <label>Analysis Type</label>
    <select id="analysisType">
      <option value="CREATED">Created (Col E)</option>
      <option value="JOINING">Joining (Col J)</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Select Date</label>
    <select id="dateFilter">
      <option value="ALL">All Dates</option>
    </select>
  </div>
</div>

<div id="resultsContainer"></div>

<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQosG1886lb-AuGEol8xxZDg86byv_mYktRIpTU9F9iCQPH4GSkY_xwX5WAYZBLiBDZuUO67pidUvEr/pub?gid=0&single=true&output=csv';

const typeSelect = document.getElementById('analysisType');
const dateSelect = document.getElementById('dateFilter');
const container = document.getElementById('resultsContainer');

let masterData = [];

function parseCSV(line){
  const out=[]; let cur='',qt=false;
  for(const ch of line){
    if(ch=='"') qt=!qt;
    else if(ch==','&&!qt){out.push(cur);cur='';}
    else cur+=ch;
  }
  out.push(cur);
  return out.map(v=>v.replace(/^"|"$/g,'').trim());
}

fetch(csvUrl).then(r=>r.text()).then(csv=>{
  const lines = csv.trim().split('\n');
  const headers = parseCSV(lines[0]);

  masterData = lines.slice(1).map(l => {
    const c = parseCSV(l);
    return {
      name: c[0] || 'N/A', // Assuming Col A is Name
      phone: (c[1] || '').replace(/\D/g,'').slice(-10), // Assuming Col B is Phone
      created: c[4] || '', // Col E
      joining: c[9] || '', // Col J
      expiry: c[headers.findIndex(x=>x.toLowerCase().includes('expiry'))] || '',
      center: c[headers.findIndex(x=>x.toLowerCase().includes('center'))] || '',
      fees: c[headers.findIndex(x=>x.toLowerCase().includes('fees'))] || '',
      plan: c[headers.findIndex(x=>x.toLowerCase().includes('plan'))] || ''
    };
  });

  updateDateOptions();
  render();
});

function updateDateOptions() {
  const type = typeSelect.value;
  const dates = new Set();
  
  masterData.forEach(r => {
    const d = type === 'CREATED' ? r.created : r.joining;
    if(d) dates.add(d);
  });

  // Sort dates descending (Latest first)
  const sortedDates = [...dates].sort((a,b) => {
    const parse = (s) => {
      let [dd,mm,yy] = s.split('-');
      return new Date(2000+parseInt(yy), mm-1, dd);
    };
    return parse(b) - parse(a);
  });

  dateSelect.innerHTML = '<option value="ALL">All Dates</option>';
  sortedDates.forEach(d => {
    dateSelect.insertAdjacentHTML('beforeend', `<option value="${d}">${d}</option>`);
  });
}

function render() {
  const type = typeSelect.value;
  const selectedDate = dateSelect.value;
  container.innerHTML = '';

  let filtered = masterData.filter(r => {
    const dateToMatch = type === 'CREATED' ? r.created : r.joining;
    return (selectedDate === 'ALL' || dateToMatch === selectedDate) && dateToMatch !== '';
  });

  if(filtered.length === 0) {
    container.innerHTML = '<div class="no-data">No records found for this selection.</div>';
    return;
  }

  filtered.forEach(r => {
    // Shared Card UI
    const html = `
      <div class="data-card">
        <div class="card-header">
          <div>
            <span class="full-name">${r.name}</span>
            <span class="sub-details">${r.center} ‚Ä¢ ${r.fees}</span>
          </div>
          <a href="tel:${r.phone}" class="phone-btn">üìû ${r.phone}</a>
        </div>
        <div class="grid-info">
          <div class="info-box"><label>Created</label><span>${r.created}</span></div>
          <div class="info-box"><label>Joining</label><span>${r.joining}</span></div>
          <div class="info-box"><label>Expiry</label><span>${r.expiry}</span></div>
          <div class="info-box"><label>Plan</label><span>${r.plan}</span></div>
        </div>
      </div>`;
    container.insertAdjacentHTML('beforeend', html);
  });
}

// Listeners
typeSelect.addEventListener('change', () => {
  updateDateOptions();
  render();
});
dateSelect.addEventListener('change', render);

</script>
</body>
</html>